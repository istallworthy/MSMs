---
title: "exampleTutorialRevised"
author: "Isa Stallworthy"
date: "`r Sys.Date()`"
output: html_document
---


Recommended workflow for using the devMSMs package with longitudinal data.

### Core inputs
```{r}

library(devtools)
library(roxygen2)

home_dir <- '/Users/isabella/Library/CloudStorage/Box-Box/BSL General/MSMs/testing'

exposure <- "ESETA1"

exposure_time_pts <- c(6, 15, 24, 35, 58)

outcome <- "EF_avg_perc.58"

tv_confounders <- c("SAAmylase.6","SAAmylase.15", "SAAmylase.24",
                    "MDI.6", "MDI.15",                                            
                    "pcx_engaged.6","pcx_engaged.15", "pcx_engaged.24", "pcx_engaged.35", "pcx_CompTwo.58",                                       
                    "RHasSO.6", "RHasSO.15", "RHasSO.24", "RHasSO.35", "RHasSO.58",                                           
                    "WndNbrhood.6","WndNbrhood.24", "WndNbrhood.35", "WndNbrhood.58",                                       
                    "IBRAttn.6", "IBRAttn.15", "IBRAttn.24",                                   
                    "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58",                                           
                    "HOMEETA1.6", "HOMEETA1.15", "HOMEETA1.24", "HOMEETA1.35", "HOMEETA1.58",                                       
                    "InRatioCor.6", "InRatioCor.15", "InRatioCor.24", "InRatioCor.35", "InRatioCor.58",                                      
                    "ESETA1.6", "ESETA1.15", "ESETA1.24", "ESETA1.35", "ESETA1.58",                                         
                    "CORTB.6", "CORTB.15", "CORTB.24",                                                                                
                    "EARS_TJo.24", "EARS_TJo.35",                                        
                    "LESMnPos.24", "LESMnPos.35",                                  
                    "LESMnNeg.24", "LESMnNeg.35",       
                    "ALI_Le.35",
                    "StrDif_Tot.35", "StrDif_Tot.58",   
                    "EF_avg_perc.35", "EF_avg_perc.58") 

ti_confounders <- c("state", "BioDadInHH2", "PmAge2", "PmBlac2", "TcBlac2", "PmMrSt2", "PmEd2", "KFASTScr",
                    "RMomAgeU", "RHealth", "HomeOwnd", "SWghtLB", "SurpPreg", "SmokTotl", "DrnkFreq",
                    "peri_health", "mat_health", "gov_asst") 

```

### Testing data
```{r}
data_orig <- read.csv("/Users/isabella/Library/CloudStorage/Box-Box/BSL General/MSMs/Tutorial paper/merged_tutorial_filtered.csv", header = TRUE)

data_orig <- data_orig %>%
  select(-c(contains(":")))

#example mids imputed data
# saveRDS(imputed_data, file = file.path(home_dir, "imputed_data.rds"))
data_mids <- readRDS(paste0(home_dir, "/imputed_data.rds"))

#example path to imputed data
data_path <- "/Users/isabella/Library/CloudStorage/Box-Box/BSL General/MSMs/testing/imputations/"

data_df <- data_mids[[1]]
data_df <- data_df %>% select(-c(contains(c(":", "Childhood", "Infancy", "Toddlerhood"))))

data <- data_df
data <- data_mids
```


### Preliminary steps (optional)
```{r}

#optional function to format long data data
data_long <- formatLongData(home_dir, data_orig, exposure, exposure_time_pts, outcome, tv_confounders, 
                            time_var = "TAge", 
                            id_var = "S_ID", 
                            missing = NA, 
                            factor_confounders = c("state","TcBlac2", "PmBlac2", "RHasSO"))

  


#format data from long to wide for imputation
v <- sapply(strsplit(tv_confounders, "\\."), "[",1)
v <- v[!duplicated(v)]
data_wide <- stats::reshape(data = data_long, 
                            idvar = "ID", 
                            v.names = v, 
                            timevar = "WAVE", 
                            times = c(6,15,24,35,58), 
                            direction = "wide")
data_wide <- data_wide[,colSums(is.na(data_wide))<nrow(data_wide)]

data_wide <- imputed_data[[1]]


#impute wide data to account for missingness
m <- 5
method <- "rf"; #pmm, midastouch, sample, cart , rf (default)
imputed_data <- imputeData(data_wide, m, method, home_dir, exposure, outcome, tv_confounders, ti_confounders, 
                           read_imps_from_file="no")


#testing
data <- data_wide
data <- imputed_data
```

#### Preliminary recommended data inspection
```{r}

#optional function visualize & summarize confounders with long or wide data either as a single df or imputed (will use imp=0) and view exposure histories 
# can take a single df (wide/long) and will uses first imputation from mids/imp input
epochs <- data.frame(epochs=c("Infancy", 
                              "Toddlerhood", 
                              "Childhood"), # optional subsetting of time points into more coarse epochs that will constitute exposure  histories
                     values=I(list(c(6,15), c(24,35), c(58)))) 

hi_lo_cut <- c(0.6, 0.3) #optional list of quantiles specifying high and low cutoff values for continuous expsures; default are c(0.75, 0.25)

#optional reference history (required if comparisons are specified)
reference <- NA #optional reference history for custom comparisons (e.g, "l-l-l") 
reference <- "l-l-l"

#optional comparison history/historis
comparison <- NULL #optional list of histories/history for custom comparisons 
comparison <- "h-h-h" #single
comparison <- c("h-h-h", "h-h-l") #multiple

inspectData(data, home_dir, exposure, exposure_time_pts, outcome, tv_confounders, ti_confounders, epochs, hi_lo_cut, reference, comparison)


```


### Pre-balance checking
```{r}

## Create full formulas

#optional concurrent confounders
concur_conf = NULL #optional list of time-varying confounders (var.t) to include in formulas concurrently (default is only lagged); exposure variables will be omitted at concurrent time poin
concur_conf = "B18Raw.15"

#optional list of tv confounders to always retain (lag t-1)
keep_conf  <-  NULL #optional list of any time-varying confounders to always retain in all formulas at lag-1 (default is none)
keep_conf <- "InRatioCor.6"

#optional custom formulas
custom <- NULL
custom <- list(formulas = as.formula("ESETA1.6 ~ BioDadInHH2 + DrnkFreq + gov_asst + HomeOwnd + KFASTScr +  mat_health + peri_health + PmAge2 + PmBlac2 + PmEd2 + PmMrSt2 + RHealth + RMomAgeU + SmokTotl + state + SurpPreg + SWghtLB + TcBlac2"))
names(custom) <-c("full_form_ESETA1-EF_avg_perc.58-6")
custom <- full_formulas

rm(bal_stats)

type = "full" # "full" =all tv covars; "short" =only t-1 tv covars; "update" = update short forms w/ imbalanced tv covars t>1
full_formulas <- createFormulas(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, ti_confounders, bal_stats = NULL, type, 
                                concur_conf, keep_conf, custom, user.o = TRUE)





## Conduct exploratory pre-balance checking

#optional balance threshold specification
rm(balance_thresh) #don't specify 
balance_thresh <- 0.1 
balance_thresh <- c(0.05, 0.1) #optional list of balance thresholds for importnt & less important confoundres, respectively; one entry will be applied to all confounders; default is 0.1 for all

#optional list of important confounders
imp_conf <- c("PmAge2", "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58") #optional list of important confounders that will be held to a stricter balance thresh
imp_conf <- NULL

type <- "prebalance"
formulas <- full_formulas
prebalance_stats <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome,  tv_confounders, type, formulas, weights = NULL,
                                  balance_thresh, imp_conf, user.o = TRUE)


```


### Determine optimal weighting method
```{r}

## Create simplified formulas

#optional list of concurrent confounder
concur_conf <-  NULL #optional list of time-varying confounders (var.t) to include in formulas concurrently (default is only lagged); exposure variables will be omitted at concurrent time point 
concur_conf <- "B18Raw.15"

#optional list of tv confounders to always retain (lag t-1)
keep_conf  <-  NULL #optional list of any time-varying confounders to always retain in all formulas at lag-1 (deafault is none)
keep_conf <- "InRatioCor.6"

#optional custom formulas
custom <- list(formulas = as.formula("ESETA1.6 ~ BioDadInHH2 + DrnkFreq + gov_asst + HomeOwnd + KFASTScr +  mat_health + peri_health + PmAge2 + PmBlac2 + PmEd2 + PmMrSt2 + RHealth + RMomAgeU + SmokTotl + state + SurpPreg + SWghtLB + TcBlac2"))
names(custom) <-c("short_form_ESETA1-EF_avg_perc.58-6")
custom <- short_formulas
rm(custom)

rm(bal_stats)

type <- "short" # "full" =all tv covars; "short" =only t-1 tv covars; "update" = update short forms w/ imbalanced tv covars t>1
short_formulas <- createFormulas(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, ti_confounders, bal_stats = NULL, type, 
                                 concur_conf, keep_conf, user.o = TRUE)



## Iterate through creating weights/assessing balance for all possible weights methods to identify the best one 


## Create balancing weights with simplified formulas
formulas <- short_formulas

method = "ps"; # optional weighting method "glm", "gbm", "bart", "super", "cbps"  (default is cbps)
weights.ps <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                            method, read_in_from_file = "no", user.o = TRUE)

method = "cbps"; # optional weighting method "glm", "gbm", "bart", "super", "cbps"  (default is cbps)
weights.cbps <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                              method, read_in_from_file = "no", user.o = TRUE)

method = "glm"; # optional weighting method "glm", "gbm", "bart", "super", "cbps" (default is cbps)
weights.glm <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                             method, read_in_from_file = "no", user.o = TRUE)

method = "gbm"; # optional weighting method "glm", "gbm", "bart", "super", "cbps"  (default is cbps)
weights.gbm <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                             method, read_in_from_file = "no", user.o = TRUE)

method = "bart"; # optional weighting method "glm", "gbm", "bart", "super", "cbps"  (default is cbps)
weights.bart <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                              method, read_in_from_file = "no", user.o = TRUE)

method = "super"; # optional weighting method "glm", "gbm", "bart", "super", "cbps" (default is cbps)
weights.super <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                               method, read_in_from_file = "no", user.o = TRUE)



## Assess balance using simplified formulas

#optional balance threshold specification
balance_thresh <- 0.1 
balance_thresh <- c(0.05, 0.1) #optional list of balance thresholds for importnt & less important confoundres, respectively; one entry will be applied to all confounders; default is 0.1 for all

#optional list of important confounders
imp_conf <- c("PmAge2", "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58") #optional list of important confounders that will be held to a stricter balance thresh
imp_conf <- NULL

type <- "weighted"
formulas <- short_formulas

weights <- weights.ps 
balance_stats.ps <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                  balance_thresh, imp_conf, user.o = TRUE)

weights <- weights.cbps 
balance_stats.cbps <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                    balance_thresh, imp_conf, user.o = TRUE)

weights <- weights.glm 
balance_stats.glm <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                   balance_thresh, imp_conf, user.o = TRUE)

weights <- weights.gbm
balance_stats.gbm <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                   balance_thresh, imp_conf, user.o = TRUE)

weights <- weights.bart
balance_stats.bart <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                    balance_thresh, imp_conf, user.o = TRUE)

weights <- weights.super 
balance_stats.super <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                     balance_thresh, imp_conf, user.o = TRUE)



# identify best weights 
formulas <- short_formulas
method  <-  "ps"; # add best method here
best_method_weights <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                                     method, read_in_from_file = "yes", user.o = TRUE) 


```


### Re-specify weights using optimal method
```{r}

## Assess balance of optimal weights using full formulas

#optional balance threshold specification
balance_thresh <- 0.1 
balance_thresh <- c(0.05, 0.1) #optional list of balance thresholds for importnt & less important confoundres, respectively; one entry will be applied to all confounders; default is 0.1 for all

#optional list of important confounders
imp_conf <- c("PmAge2", "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58") #optional list of important confounders that will be held to a stricter balance thresh
imp_conf <- NULL

type <- "weighted"
formulas <- full_formulas
weights <- best_method_weights

balance_stats <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                               balance_thresh, imp_conf, user.o = TRUE)



## Update short formulas with any t->1 tv confounders that were not balanced
#optional custom formulas
custom <- list(formulas = as.formula("ESETA1.6 ~ BioDadInHH2 + DrnkFreq + gov_asst + HomeOwnd + KFASTScr +  mat_health + peri_health + PmAge2 + PmBlac2 + PmEd2 + PmMrSt2 + RHealth + RMomAgeU + SmokTotl + state + SurpPreg + SWghtLB + TcBlac2"))
names(custom) <-c("update_form_ESETA1-EF_avg_perc.58-6")
custom <- updated_formulas
custom <- NULL

#optional list of concurrent confounder
concur_conf <-  NULL #optional list of time-varying confounders (var.t) to include in formulas concurrently (default is only lagged); exposure variables will be omitted at concurrent time point 
concur_conf <- "B18Raw.15"

#optional list of tv confounders to always retain (lag t-1)
keep_conf <- NULL #optional list of any time-varying confounders to always retain in all formulas at lag-1 (deafault is none)
keep_conf <- "InRatioCor.6"

type <- "update" # "full" =all tv covars; "short" =only t-1 tv covars; "update" = update short forms w/ imbalanced tv covars t>1
bal_stats <- balance_stats
updated_formulas <- createFormulas(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, ti_confounders, type, bal_stats, 
                                   concur_conf, keep_conf, user.o = TRUE)



# Re-specify weights with optimal method and updated formulas 
formulas <- updated_formulas
method <- "ps"; # optional weighting method "glm", "gbm", "bart", "super", "cbp (default is cbps)
final_weights <- createWeights(home_dir, data, exposure, outcome, tv_confounders, formulas, 
                               method, read_in_from_file = "no", user.o = TRUE) 



# Truncate weights to reduce heavy tails --
weights <- final_weights

quantile <- 0.95 # optional quantile of weights above which weights are trimmed (default is 0.95)
trim_weights <- trimWeights(home_dir, weights, quantile, 
                            user.o = TRUE) #this is just a wrapper function for the trim function to allow for summaries and plotting

#sensitivity tests   
quantile <- 0.92 #optional quantile of weights above which weights are trimmed (default is 0.95)
trim_weights.s1 <- trimWeights(home_dir, weights, quantile, 
                               user.o = TRUE) #this is just a wrapper function for the trim function to allow for summaries and plotting

quantile <- 0.98 #optional quantile of weights above which weights are trimmed (default is 0.95)
trim_weights.s2 <- trimWeights(home_dir, weights, quantile, 
                               user.o = TRUE) #this is just a wrapper function for the trim function to allow for summaries and plotting


```


### Final balance assessment
```{r}

## Assess balance of final, trimmed weights 

#optional balance threshold specification
balance_thresh <- 0.1 
balance_thresh <- c(0.05, 0.1) #optional list of balance thresholds for importnt & less important confoundres, respectively; one entry will be applied to all confounders; default is 0.1 for all

#optional list of important confounders
imp_conf <- c("PmAge2", "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58") #optional list of important confounders that will be held to a stricter balance thresh
imp_conf <- NULL

type <- "weighted"
formulas <- full_formulas
weights <- trim_weights
final_balance_stats <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                     balance_thresh, imp_conf, user.o = TRUE)


#sensitivity tests
weights <- trim_weights.s1
final_balance_stats.s1 <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                        balance_thresh, imp_conf, user.o = TRUE)

weights <- trim_weights.s2
final_balance_stats.s2 <- assessBalance(home_dir, data, exposure, exposure_time_pts, outcome, tv_confounders, type, formulas, weights, 
                                        balance_thresh, imp_conf, user.o = TRUE)

```


### Fit marginal structural model & summarize results

```{r}

#optional family/link information for glm
family <- gaussian  #optional family reflective of outcome distribution
link <- "identity" #optional link function

# max interaction order (required for interaction models m2-3)
int_order = 3

#covariates (required for covariate models m1, m3)
covariates <- c("ESETA1.6", "gov_asst") #optional list of covariates (e.g., those remaining imbalanced) for covariate models (m1, m3)

#optional specification of epochs
epochs <- data.frame(epochs=c("Infancy", "Toddlerhood", "Childhood"), # optional subsetting of time points into more coarse epochs 
                             values=I(list(c(6,15), c(24,35), c(58)))) 


model <- "m3"
weights <- trim_weights
models <- fitModel(home_dir, data, weights, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                   family, link, int_order, covariates, epochs, user.o = TRUE)  


#sensitivity tests
weights <- trim_weights.s1
models.s1 <- fitModel(home_dir, data, weights, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                      family, link, int_order, covariates, epochs, user.o = TRUE)

weights <- trim_weights.s2
models.s2 <- fitModel(home_dir, data, weights, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                      family, link, int_order, covariates, epochs, user.o = TRUE)




## Estimate, compare, & visualize effects of exposure histories on outcome

#optional list of quantiles specifying high and low cutoff values for continuous exposures; 
hi_lo_cut <- c(0.6, 0.3) #default are median split

#optional reference history (required if comparisons are specified)
reference <- NA #optional reference history for custom comparisons (e.g, "l-l-l") 
reference <- "l-l-l"

#optional comparison history/historis
comparison <- NULL #optional list of histories/history for custom comparisons 
comparison <- "h-h-h" #single
comparison <- c("h-h-h", "h-h-l") #multiple

#optional multiple comparion method
mc_comp_method<- "BY" # default is Benjamini-Hochburg, ("holm", "hochberg","hommel", "bonferroni", "BH", "BY", "fdr", "none" (see stats::p.adjust() documentation)
  
#optional specification of dose level (high or low) for dose count
dose_level <- "l" #(default is "h")

#optional exposure label for plotting
exp_lab <- "Economic Strain" # (default is var name)

#optional outcome label for plotting 
out_lab <- "Executive Functioning" #(default is var name)

# optional list of colors (equal to number of epochs +1) or brewer palette for plotting
colors <- (c("Dark2"))  #(see RColorBrewer::display.brewer.all() or https://r-graph-gallery.com/38-rcolorbrewers-palettes.html) for plotting default is 'Dark2'); c("blue4", "darkgreen", "darkgoldenrod", "red2")
 
 
model <- models #output from fitModel
results <- compareHistories(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                            epochs, hi_lo_cut, reference, comparison, mc_comp_method , dose_level, exp_lab, out_lab, colors, user.o = TRUE)


#sensitivity tests
model <- models.s1 #output from fitModel
results.s1 <- compareHistories(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                               epochs, hi_lo_cut, reference, comparison, mc_comp_method , dose_level, exp_lab, out_lab, colors, user.o = TRUE)

model <- models.s2 #output from fitModel
results.s2 <- compareHistories(home_dir, exposure, exposure_time_pts, outcome, tv_confounders, model, 
                               epochs, hi_lo_cut, reference, comparison, mc_comp_method , dose_level, exp_lab, out_lab, colors, user.o = TRUE)

```

Package citations
```{r}

```

