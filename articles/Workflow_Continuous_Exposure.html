<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="devMSMs">
<title>Workflow: Continuous Exposure • devMSMs</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Workflow: Continuous Exposure">
<meta property="og:description" content="devMSMs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">devMSMs</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Data_Requirements.html">Data Requirements</a>
    <a class="dropdown-item" href="../articles/Preliminary_Steps.html">Preliminary Steps</a>
    <a class="dropdown-item" href="../articles/Specify_Core_Inputs.html">Specify Core Inputs</a>
    <a class="dropdown-item" href="../articles/Terminology.html">Terminology</a>
    <a class="dropdown-item" href="../articles/Workflow_Continuous_Exposure.html">Workflow: Continuous Exposure</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/istallworthy/devMSMs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Workflow: Continuous Exposure</h1>
                        <h4 data-toc-skip class="author">Isabella
Stallworthy</h4>
            
            <h4 data-toc-skip class="date">2023-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/istallworthy/devMSMs/blob/HEAD/vignettes/Workflow_Continuous_Exposure.Rmd" class="external-link"><code>vignettes/Workflow_Continuous_Exposure.Rmd</code></a></small>
      <div class="d-none name"><code>Workflow_Continuous_Exposure.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Installing package into '/home/runner/work/_temp/Library'</span></span>
<span><span class="co">#&gt; (as 'lib' is unspecified)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: usethis</span></span>
<span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"istallworthy/devMSMs"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://istallworthy.github.io/devMSMs/">devMSMs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"istallworthy/devMSMsHelpers"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">devMSMsHelpers</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>This vignette guides a user through the process of using
<em>devMSMs</em> with a continuously distributed exposure variable. The
users should first view the
<a href="https://istallworthy.github.io/devMSMs/articles/Terminology.html">Terminology</a>,
Data Requirements,
<a href="https://istallworthy.github.io/devMSMs/articles/Specify_Core_Inputs.html">Specifying
Core Inputs</a>, and
<a href="https://istallworthy.github.io/devMSMs/articles/Preliminary_Steps.html">Preliminary
Steps</a> vignettes.</p>
<p>The following suggested workflow and constituent steps are also
reflected in
<a href="https://github.com/istallworthy/devMSMs/blob/main/examplePipelineRevised.Rmd" class="external-link">examplePipeline.rmd
file</a>. This workflow is designed to complement the conceptual and
high-level practical details provided in the manuscript [add link here].
We strongly suggest users familiarize themselves with concepts of the
MSM process outlined in the manuscript and the practical steps and
functions put forth in the following sections before implementing this
workflow.</p>
<p>All <em>devMSMs</em> functions have optional arguments to suppress
saving output locally (<code>save.out = FALSE</code>) and printing it to
the console ( <code>verbose = FALSE</code>). The defaults to both
arguments are TRUE. Users must supply a path to a home directory if
<code>save.out = TRUE</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">save.out</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span></span>
<span><span class="va">verbose</span> <span class="op">=</span> <span class="cn">TRUE</span></span></code></pre></div>
<p><br></p>
<div class="section level3">
<h3 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h3>
<p>We first load a data frame of complete data. (See
<a href="https://istallworthy.github.io/devMSMs/articles/Preliminary_Steps.html">Preliminary
Steps vignette</a> for beginning with other data types, including
missing data).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># data &lt;- read.csv('/Users/isabella/Library/CloudStorage/Box-Box/BSL General/MSMs/testing/testing data/continuous outcome/continuous exposure/FLP_wide_imputed.csv')</span></span>
<span><span class="co">#temporary data until we get sim data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span>
<span>                   ESETA1.6 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   ESETA1.15 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   ESETA1.24 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   peri_health <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   gov_assist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   InRatioCor.6 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   InRatioCor.15 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   InRatioCor.24 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   WndNbrhood.6 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   WndNbrhood.15 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   WndNbrhood.24 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                   StrDif_Tot.58 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then check to see if there are any character variables present in
the data and convert them to integers.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">class</span><span class="op">)</span> <span class="op">==</span> <span class="st">"character"</span><span class="op">)</span> <span class="co">#if this is TRUE, run next lines</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">class</span><span class="op">)</span> <span class="op">==</span> <span class="st">"character"</span><span class="op">]</span> <span class="co">#find names of any character variables</span></span>
<span><span class="co">#&gt; character(0)</span></span>
<span></span>
<span><span class="co">#data[, "state"] &lt;- factor(data[, "state"], labels = c(1, 0)) #run this for each variable that needs char -&gt; factor</span></span></code></pre></div>
<p>We then make factor variables factor class.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># factor_covars &lt;- c("state", "TcBlac2","BioDadInHH2","HomeOwnd", "PmBlac2",       </span></span>
<span><span class="co">#                    "PmMrSt2", "SurpPreg", "RHealth", "SmokTotl", "DrnkFreq",</span></span>
<span><span class="co">#                    "RHasSO.6", "RHasSO.15", "RHasSO.24", "RHasSO.35", "RHasSO.58")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data[, factor_covars] &lt;- as.data.frame(lapply(data[, factor_covars], as.factor))</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level3">
<h3 id="core-inputs">Core inputs<a class="anchor" aria-label="anchor" href="#core-inputs"></a>
</h3>
<p>Please see the Specifying Core Inputs vignette for more detail on the
following core inputs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#set seed for reproducibility </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#required if you wish to use save.out = TRUE in the functions</span></span>
<span><span class="va">home_dir</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="co"># home_dir &lt;- '/Users/isabella/Library/CloudStorage/Box-Box/BSL General/MSMs/testing/isa' #note: no / after</span></span>
<span></span>
<span><span class="co">#required</span></span>
<span><span class="va">exposure</span> <span class="op">&lt;-</span> <span class="st">"ESETA1"</span></span>
<span></span>
<span><span class="co">#required</span></span>
<span><span class="va">exposure_time_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">15</span>, <span class="fl">24</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#required</span></span>
<span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="st">"StrDif_Tot.58"</span></span>
<span></span>
<span><span class="co">#required; list in wide format</span></span>
<span><span class="va">tv_confounders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                    <span class="co"># "SAAmylase.6","SAAmylase.15", "SAAmylase.24",</span></span>
<span>                    <span class="co"># "MDI.6", "MDI.15",                                            </span></span>
<span>                    <span class="co"># "RHasSO.6", "RHasSO.15", "RHasSO.24","RHasSO.35", "RHasSO.58",                                         </span></span>
<span>                    <span class="st">"WndNbrhood.6"</span>,<span class="st">"WndNbrhood.15"</span>, <span class="st">"WndNbrhood.24"</span>, <span class="co">#"WndNbrhood.35", "WndNbrhood.58",                                       </span></span>
<span>                    <span class="co"># "IBRAttn.6", "IBRAttn.15", "IBRAttn.24",                                   </span></span>
<span>                    <span class="co"># "B18Raw.6", "B18Raw.15", "B18Raw.24", "B18Raw.58",                                           </span></span>
<span>                    <span class="co"># "HOMEETA1.6", "HOMEETA1.15", "HOMEETA1.24", "HOMEETA1.35", "HOMEETA1.58",                               </span></span>
<span>                    <span class="st">"InRatioCor.6"</span>, <span class="st">"InRatioCor.15"</span>, <span class="st">"InRatioCor.24"</span>, <span class="co">#"InRatioCor.35", "InRatioCor.58",                         </span></span>
<span>                    <span class="st">"ESETA1.6"</span>, <span class="st">"ESETA1.15"</span>, <span class="st">"ESETA1.24"</span><span class="co"># "ESETA1.35", "ESETA1.58",  #exposure variables required               </span></span>
<span>                    <span class="co"># "CORTB.6", "CORTB.15", "CORTB.24",                                                                  </span></span>
<span>                    <span class="co"># "EARS_TJo.24", "EARS_TJo.35",                                        </span></span>
<span>                    <span class="co"># "LESMnPos.24", "LESMnPos.35",                                  </span></span>
<span>                    <span class="co"># "LESMnNeg.24", "LESMnNeg.35",       </span></span>
<span>                    <span class="co"># "StrDif_Tot.35", </span></span>
<span>                    <span class="co"># "StrDif_Tot.58"    </span></span>
<span>                    <span class="co"># "fscore.35", "fscore.58"</span></span>
<span>                    <span class="co"># , "ESETA1.6:B18Raw.6", "ESETA1.6:B18Raw.15:RHasSO.6", "state:EARS_TJo.35" #testing interactions</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co">#required</span></span>
<span><span class="va">ti_confounders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                    <span class="co"># "state", "BioDadInHH2", "PmAge2", "PmBlac2", "TcBlac2", "PmMrSt2", "PmEd2", "KFASTScr",</span></span>
<span>                    <span class="co"># "RMomAgeU", "RHealth", "HomeOwnd", "SWghtLB", "SurpPreg", "SmokTotl", "DrnkFreq",</span></span>
<span>                    <span class="st">"peri_health"</span>, </span>
<span>                    <span class="co"># "caregiv_health", </span></span>
<span>                    <span class="st">"gov_assist"</span></span>
<span>                    <span class="co">#, "state:SmokTotl", "PmAge2:PmBlac2", "PmAge2:PmEd2" #testing interaction terms</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><br><br></p>
</div>
<div class="section level2">
<h2 id="phase-1-confounder-adjustment">Phase 1: Confounder Adjustment<a class="anchor" aria-label="anchor" href="#phase-1-confounder-adjustment"></a>
</h2>
<p>The goal of this first phase is to minimize the associations between
confounders and exposure using IPTW balancing weights. We strongly
advise the user to carefully inspect each balancing formula to ensure
weights are created and evaluated appropriately at each step.</p>
<p><br></p>
<div class="section level3">
<h3 id="step-1--create-full-balancing-formulas-conduct-pre-balance-checking">Step 1. Create Full Balancing Formulas &amp; Conduct Pre-Balance
Checking<a class="anchor" aria-label="anchor" href="#step-1--create-full-balancing-formulas-conduct-pre-balance-checking"></a>
</h3>
<p><br></p>
<div class="section level4">
<h4 id="step-1a--create-full-balancing-formulas-conduct-pre-balance-checking">Step 1a. Create Full Balancing Formulas &amp; Conduct Pre-Balance
Checking<a class="anchor" aria-label="anchor" href="#step-1a--create-full-balancing-formulas-conduct-pre-balance-checking"></a>
</h4>
<p>We first create comprehensive, full balancing formulas relating
exposure to confounders at each time point using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function (<code>type = “full”</code>).
This step creates full formulas containing all measured confounding
variables at each exposure time point, including all time-invariant
confounders, lagged time-varying confounders, as well as past levels of
the exposure and outcome (make sure they are listed as time-varying
confounders). The code automatically excludes time-varying confounders
at the contemporaneous time point given that they cannot be decisively
differentiated from mediators which should not be balanced on (Thoemmes
&amp; Ong, 2016), although this can be modified by the user if they have
strong reason to believe a concurrent variable is not a mediator (see
below).</p>
<p>To include interactions between covariates in the balancing formulas,
please list those composed of only time invariant covariates (e.g.,
“variable:variable” or “variable.t:variable.t”) as time invariant
confounders, and those composed of both or only time-varying covariates
(e.g., “variable.t:variable” or “variable.t:variable.t”) in the
time-varying confounders list. Interactions containing time-varying
covariates will be treated as time-varying confounders measured at the
highest measurement time point of the constituent time points. Of note,
interactions between factor variables with multiple levels can produce a
large number of additional variables in the balancing formulas.</p>
<p>The required input to create full balancing formulas using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function are: exposure (e.g., “variable”),
exposure time points, outcome (e.g., “variable.time”), a list of
time-varying confounders (e.g. “variable.time”), a list of time
invariant confounders (e.g., “variable”), and setting
<code>type = “full”</code>.</p>
<p>Optional inputs to create full balancing formulas using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function are as follows.</p>
<p>For <code>concur_conf</code>: as a list, provide the names of any
time-varying confounders (e.g., “variable.time”) that you wish to be
included concurrently in the balancing formulas (overriding the default
which is to only include lagged confounders).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">concur_conf</span> <span class="op">&lt;-</span> <span class="st">"B18Raw.15"</span></span>
<span></span>
<span><span class="va">concur_conf</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co">#empirical example </span></span></code></pre></div>
<p>The user may also specify a list of custom formulas by specifying to
custom a list of formulas, one for each exposure time point (e.g.,
“exposure.time ~ variable.time + variable +…”) in formula format, with
each entry named with the formula type and exposure time point (e.g.,
“full_form-6”). An abridged example is shown below. The
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function will automatically check custom
formulas to ensure that there is a correctly formatted formula for each
exposure time point with exposure as the dependent variable. However,
the user is responsible for ensuring the custom formulas contain the
appropriate confounders for the formula type they are generating.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"full_form-6"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="st">"ESETA1.6 ~ BioDadInHH2 + DrnkFreq + gov_assist"</span><span class="op">)</span>,</span>
<span>               <span class="st">"full_form-15"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="st">"ESETA1.15 ~ BioDadInHH2 + DrnkFreq + gov_assist"</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">custom</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> </span></code></pre></div>
<p>The <code>createFormulas</code> function saves out .csv and .rds
files containing balancing formulas at each exposure time point for the
specified <code>type</code> (“full”) in the ‘formulas/full/’ folder.</p>
<p>The function returns a list of formulas labeled by type, exposure,
outcome, and exposure time point.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"full"</span></span>
<span></span>
<span><span class="va">full_formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createFormulas.html">createFormulas</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, <span class="co">#required</span></span>
<span>                                type <span class="op">=</span> <span class="va">type</span>, ti_confounders <span class="op">=</span> <span class="va">ti_confounders</span>, tv_confounders <span class="op">=</span> <span class="va">tv_confounders</span>, <span class="co">#required</span></span>
<span>                                concur_conf <span class="op">=</span> <span class="va">concur_conf</span>, custom <span class="op">=</span> <span class="va">custom</span>, <span class="co">#optional</span></span>
<span>                                home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the full balancing formula below:</span></span>
<span><span class="co">#&gt; The full formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 6 is: </span></span>
<span><span class="co">#&gt; ESETA1.6 ~ gov_assist + peri_health</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb3f57b00&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the full balancing formula below:</span></span>
<span><span class="co">#&gt; The full formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 15 is: </span></span>
<span><span class="co">#&gt; ESETA1.15 ~ ESETA1.6 + gov_assist + InRatioCor.6 + peri_health + </span></span>
<span><span class="co">#&gt;     WndNbrhood.6</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb3f57b00&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the full balancing formula below:</span></span>
<span><span class="co">#&gt; The full formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 24 is: </span></span>
<span><span class="co">#&gt; ESETA1.24 ~ ESETA1.15 + ESETA1.6 + gov_assist + InRatioCor.15 + </span></span>
<span><span class="co">#&gt;     InRatioCor.6 + peri_health + WndNbrhood.15 + WndNbrhood.6</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb3f57b00&gt;</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level4">
<h4 id="step-1b--conduct-exploratory-pre-balance-assessment">Step 1b. Conduct Exploratory Pre-Balance Assessment<a class="anchor" aria-label="anchor" href="#step-1b--conduct-exploratory-pre-balance-assessment"></a>
</h4>
<p>The next step examines the initial imbalance, or how strongly
exposure relates to each confounder at each time point, for all measured
confounders prior to weighting using the <code><a href="../reference/assessBalance.html">assessBalance()</a></code>
function (<code>type = “prebalance”</code>). This function draws on the
<code><a href="../reference/calcBalStats.html">calcBalStats()</a></code> function (see the Assessing Balance for
Time-Varying Exposure section in the accompanyingm manuscript. The
<code><a href="../reference/assessBalance.html">assessBalance()</a></code> function outputs balance statistics
(correlations for continuous exposures and standardized mean differences
for binary exposures) relating exposure at each time point to
confounders in a table as well as in plots. This function also provides
summary balance statistics averaging across all time points (and imputed
datasets if they are supplied).</p>
<p>The required inputs for using the <code><a href="../reference/assessBalance.html">assessBalance()</a></code>
function to conduct pre balance testing are: data (data frame, a mids
object, or a list of imputed datasets as dataframes in wide format),
exposure (e.g., “variable”), exposure time points, outcome (e.g.,
“variable.time”), the full formulas (see Step 1a), and set
<code>type = “prebalance”</code>.</p>
<p>The optional inputs are as follows. The user may specify
<code>balance_thresh</code>: provide a single number value (0-1) for the
absolute value of the standardized balance statistic (either the
correlation for continuous exposures or standardized group mean
difference for binary exposures) for exposure and confounders below
which confounders are considered balanced and above which they are
considered imbalanced (default is 0.1; Stuart, 2010). The user also has
the option to supply a list of two values indicating different
thresholds for important and less important confounders, respectively,
accompanied by a list of important confounders (time-varying:
“variable.t”, time invariant: “variable”) to the <code>imp_conf</code>
field.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balance_thresh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">imp_conf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"InRatioCor.6"</span>, <span class="st">"InRatioCor.15"</span>, <span class="st">"InRatioCor.24"</span><span class="op">)</span> <span class="co">#"InRatioCor.35", "InRatioCor.58", "PmEd2") </span></span></code></pre></div>
<p>We recommend thresholds of 0.05 and 0.1 for important and less
important confounders, respectively. The relative importance of
confounders should be determined based on existing theory and conceptual
consideration. The specification of balance threshold(s) should be kept
consistent throughout the use of the <em>devMSMs</em> package.</p>
<p>The <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function saves out the following
.csv and .html files into the ‘balance/prebalance’ folder: tables of
balance statistics for all confounders, tables of balance statistics for
covariates that are imbalanced, and an overall balance summary table
(averaged across any imputed datasets). Within the
‘balance/prebalance/plots’ folder, the function outputs .jpeg files of
summary love plots depicting confounder balance for each exposure time
point.</p>
<p>The function returns a data frame (or list) of balance statistics,
balance thresholds, and binary balanced tag for each confounder relevant
to each exposure time point.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"prebalance"</span></span>
<span></span>
<span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="va">full_formulas</span></span>
<span></span>
<span><span class="va">prebalance_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, </span>
<span>                                  outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                                  balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                  home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point prior to weighting, using full formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-11-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-11-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-11-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 9 out of 15 (60%) covariates across time points, corresponding to 4 out of 5 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.22 (range= -0.36-0.27):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using no weights and full formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          0|            2|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          3|            5|  8|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the full formulas and no weights :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.1 (range = -0.36 -0.27). </span></span>
<span><span class="co">#&gt; As shown below, the following 9 covariates across time points out of 15 total (60%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.22 (range=-0.36-0.27) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |1  |ESETA1   |        6|          0|gov_assist    |  0.2636925|       0.10|        0|</span></span>
<span><span class="co">#&gt; |2  |ESETA1   |        6|          0|peri_health   |  0.2264087|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  | -0.0743755|       0.05|        0|</span></span>
<span><span class="co">#&gt; |6  |ESETA1   |       15|          0|peri_health   | -0.2249503|       0.10|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|          0|gov_assist    |  0.2695900|       0.10|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|          6|InRatioCor.6  | -0.0976274|       0.05|        0|</span></span>
<span><span class="co">#&gt; |13 |ESETA1   |       24|          0|peri_health   |  0.1336954|       0.10|        0|</span></span>
<span><span class="co">#&gt; |14 |ESETA1   |       24|         15|WndNbrhood.15 | -0.3627148|       0.10|        0|</span></span>
<span><span class="co">#&gt; |15 |ESETA1   |       24|          6|WndNbrhood.6  |  0.1655062|       0.10|        0|</span></span></code></pre>
<p><br><br> ### Step 2. Create Simplified Balancing Formulas &amp;
Determine Optimal Weighting Method The goal of this second step is to
create shortened, more parsimonious balancing formulas for determining
the optimal IPTW weighting method that most successfully reduces
imbalance.<br><br></p>
</div>
<div class="section level4">
<h4 id="a--create-simplified-balancing-formulas">2a. Create Simplified Balancing Formulas<a class="anchor" aria-label="anchor" href="#a--create-simplified-balancing-formulas"></a>
</h4>
<p>First, we create shorter, more parsimonious balancing formulas
relating exposure to confounders at each time point using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function (<code>type = ”short”</code>).
These formulas contain time-varying confounders measured only at the
<em>t</em>-1 lag for each exposure time point. The logic here is that
balancing on confounders at the most recent prior time point
(<em>t</em>-1 only) may achieve balance on levels at more distal time
points given the stability of many confounders over time. Importantly,
we will empirically assess and relax this assumption if needed at a
subsequent step.</p>
<p>See Step 1a for instructions on how to include confounder
interactions.</p>
<p>The required input to create shortened balancing formulas using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function are exposure (e.g., “variable”),
exposure time points, outcome (e.g., “variable.time”), a list of
time-varying confounders (e.g., “variable.time”), a list of time
invariant confounders, and setting <code>type = “short”</code>.</p>
<p>In addition to the optional input outlined in Step 1a, the user also
has the option to specify in <code>keep_conf</code>, a list of any
time-varying confounders (e.g., “variable.t”) to always retain in all
formulas for exposure measured at a subsequent time point. The user may
use this argument to retain specific time-varying confounders that would
otherwise may have been excluded at this step if they occur at lags
greater than <em>t</em>-1 for each formula.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keep_conf</span> <span class="op">&lt;-</span> <span class="st">"InRatioCor.6"</span></span>
<span></span>
<span><span class="va">keep_conf</span>  <span class="op">&lt;-</span>  <span class="cn">NULL</span> </span></code></pre></div>
<p>The <code><a href="../reference/createFormulas.html">createFormulas()</a></code> function saves out .csv and .rds
files containing balancing formulas at each exposure time point (e.g.,
see below) for the specified type (in this case, “short”) in the
‘formulas/short’ folder.</p>
<p>The function returns a list of balancing formulas labeled by type,
exposure, outcome, and exposure time point.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"short"</span> </span>
<span></span>
<span><span class="va">short_formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createFormulas.html">createFormulas</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, </span>
<span>                                 outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, ti_confounders <span class="op">=</span> <span class="va">ti_confounders</span>, </span>
<span>                                 tv_confounders <span class="op">=</span> <span class="va">tv_confounders</span>, concur_conf <span class="op">=</span> <span class="va">concur_conf</span>, </span>
<span>                                 keep_conf <span class="op">=</span> <span class="va">keep_conf</span>, custom <span class="op">=</span> <span class="va">custom</span>, </span>
<span>                                 home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> </span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the short balancing formula below that includes time-varying confounders at t-1 only:</span></span>
<span><span class="co">#&gt; The short formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 6 is: </span></span>
<span><span class="co">#&gt; ESETA1.6 ~ gov_assist + peri_health</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb29e0268&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the short balancing formula below that includes time-varying confounders at t-1 only:</span></span>
<span><span class="co">#&gt; The short formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 15 is: </span></span>
<span><span class="co">#&gt; ESETA1.15 ~ ESETA1.6 + gov_assist + InRatioCor.6 + peri_health + </span></span>
<span><span class="co">#&gt;     WndNbrhood.6</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb29e0268&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the short balancing formula below that includes time-varying confounders at t-1 only:</span></span>
<span><span class="co">#&gt; The short formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 24 is: </span></span>
<span><span class="co">#&gt; ESETA1.24 ~ ESETA1.15 + gov_assist + InRatioCor.15 + peri_health + </span></span>
<span><span class="co">#&gt;     WndNbrhood.15</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555cb29e0268&gt;</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level4">
<h4 id="b--create-iptw-balancing-weights-using-multiple-weighting-methods">2b. Create IPTW Balancing Weights using Multiple Weighting
Methods<a class="anchor" aria-label="anchor" href="#b--create-iptw-balancing-weights-using-multiple-weighting-methods"></a>
</h4>
<p>Having created shorter, simplified balancing formulas we now create
the first round of IPTW balancing weights (Thoemmes &amp; Ong, 2016)
using the <code><a href="../reference/createWeights.html">createWeights()</a></code> function, the shortened balancing
formulas, and all available weighting methods. The function calls the
<code>weightitMSM()</code> function from the <em>WeightIt</em> package
(Greifer, 2023) that uses the time-specific formulas to create weights
at each time point and automatically multiplies them together to create
one weight per person. Weights are stabilized, as recommended (Cole
&amp; Hernan, 2008; Thoemmes &amp; Ong, 2016), and distributions are
saved for inspection.</p>
<p>The required inputs for using the <code><a href="../reference/createWeights.html">createWeights()</a></code>
function to create the initial around of IPTW balancing weights are:
data (data frame, mids object, or a list of imputed datasets as
dataframes in wide format), exposure (e.g., “variable”), outcome (e.g.,
“variable.time”), and provide the short formulas (see Step 2a).</p>
<p>The optional inputs are as follows. For <code>method</code>, provide
one of the following methods for calculating balancing weights for use
by <code>weightitMSM()</code> from the that have been validated for
longitudinal exposures: “cbps” (Covariate Balancing Propensity Score
weighting; default), “gbm” (generalized boosted model), “glm”
(generalized linear model), or “super” (SuperLearner via the
SuperLearner package; Polley et al., 2013).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"cbps"</span></span></code></pre></div>
<p>The <code><a href="../reference/createWeights.html">createWeights()</a></code> function can also take any number of
additional arguments that will be passed to the
<code>weightitMSM ()</code> function (e.g., ‘ints’, ‘criterion’,
distribution’, ‘SL.library’). For instance, if the user wishes to
include first-order interactions of supplied covariates in the weights
model, they can include the argument <code>ints = TRUE</code>. If the
user selects the SuperLearner (“super”) method, the default super
learner library (‘SL.library’) is xx but an alternative library can be
entered as an input to the <code>createWeights</code> function. For
binary exposures, the “cbps” method allows you to specify
<code>estimand</code> as either ATE, ATT, or ATC. With “glm”, “super”,
and “bart” you can specify ATE, ATT, ATC, ATO, ATM, or ATOS. With “gbm”
you can specify ATE, ATT, ATC, ATO, or ATM. The default estimand for
binary exposures is ATE. We advise the interested user to review the
<a href="(https://ngreifer.github.io/WeightIt/reference/weightitMSM.html" class="external-link"><em>WeightIt</em>
documentation</a> for more information about the additional optional
arguments available for each of the weighting methods.</p>
<p>The user can also specify <code>read_in_from_file = TRUE</code>if the
user has previously created weights for these data, formula, and weight
type using this function and wishes to read them in from a local file
instead of recreating them. The <code><a href="../reference/createWeights.html">createWeights()</a></code> function
automatically conducts some basic checks that the saved weights match
the data type, weights method, and number of formulas provided. The user
is responsible for making sure these weights were created
appropriately.</p>
<p>The <code><a href="../reference/createWeights.html">createWeights()</a></code> function saves out an .rds file of
the weights in the ‘weights’ folder, a histogram of the weights
distribution in the ‘weights/histograms’ folder, and a .csv file of data
with the weights appended in the ‘weights/values/’ folder.</p>
<p>The function returns a list of weights objects each in the form of
WeightItMSM output in a single nested list (labeled “0” if data are in
data frame format) or with nested lists for each imputed dataset (if
data are imputed).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights.cbps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                              method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co">#optional</span></span>
<span>                              home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span>  <span class="co">#optional</span></span>
<span><span class="co">#&gt; For the cbps weighting method, the median weight value is 0.81 (SD = 1.26; range = 0.11-7).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>We then create IPTW balancing weights using all other available
methods.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"glm"</span></span>
<span><span class="va">weights.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                             method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#optional</span></span>
<span>                             home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span>  <span class="co">#optional</span></span>
<span><span class="co">#&gt; For the glm weighting method, the median weight value is 0.81 (SD = 0.55; range = 0.21-3).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"gbm"</span></span>
<span><span class="va">weights.gbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                             method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co">#optional</span></span>
<span>                             home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span>  <span class="co">#optional</span></span>
<span><span class="co">#&gt; For the gbm weighting method, the median weight value is 0.23 (SD = 0.35; range = 0.07-2).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"bart"</span></span>
<span><span class="va">weights.bart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                              method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#optional</span></span>
<span>                              home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; For the bart weighting method, the median weight value is 0.62 (SD = 0.32; range = 0.16-2).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"super"</span></span>
<span><span class="va">weights.super</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                               method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Loading required package: nnls</span></span>
<span><span class="co">#&gt; Warning: All algorithms have zero weight</span></span>
<span><span class="co">#&gt; Warning: All metalearner coefficients are zero, predictions will all be equal</span></span>
<span><span class="co">#&gt; to 0</span></span>
<span><span class="co">#&gt; For the super weighting method, the median weight value is 0.98 (SD = 0.52; range = 0.27-3).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="c--assess-all-weighting-methods-to-determine-optimal-method">2c. Assess All Weighting Methods to Determine Optimal Method<a class="anchor" aria-label="anchor" href="#c--assess-all-weighting-methods-to-determine-optimal-method"></a>
</h4>
<p>Next, we evaluate how well weights created using each of the
different weighting methods reduced imbalance for the confounders that
we provided in the short balancing formula using the
<code><a href="../reference/assessBalance.html">assessBalance()</a></code> function (<code>type = “weighted”</code>).
This function calls the <code><a href="../reference/calcBalStats.html">calcBalStats()</a></code> function using the
short formulas and specifying that the balance statistics should be
calculated using the IPTW weights that we just created. The
<code><a href="../reference/assessBalance.html">assessBalance()</a></code> function outputs balance statistics
(correlations for continuous exposures and standardized mean differences
for binary exposures) relating exposure at each time point to
confounders in a table as well as in plots. This function also provides
summary balance statistics averaging across all time points (and imputed
datasets if they are supplied).</p>
<p>The required inputs for using the <code><a href="../reference/assessBalance.html">assessBalance()</a></code>
function to assess balance for the first round of IPTW weights are: data
(data frame, mids object, or a list of imputed datasets as dataframes in
wide format), exposure (e.g., “variable”), exposure time points, outcome
(e.g., “variable.time”), providing the short formulas (see Step 2a),
setting <code>type = “weighted”</code>, and providing the weights that
were just created.</p>
<p>The optional inputs are described in Step 1b.</p>
<p>The <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function saves out the following
.csv and .html files into the ‘balance/weighted’ folder: tables of
balance statistics for all confounders, tables of balance statistics for
covariates that are imbalanced, and an overall balance summary table
(averaged across any imputed datasets). Within the
‘balance/weighted/plots’ folder, the function outputs .jpeg files of
summary love plots depicting confounder balance for each exposure time
point.</p>
<p>The function returns a data frame (or list) of balance statistics,
balance thresholds, and binary balanced tag (1 = balanced, 0 =
imbalanced) for each confounder relevant to each exposure time
point.</p>
<p>We next assess balance for each weighting method.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"weighted"</span></span>
<span></span>
<span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="va">short_formulas</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.cbps</span> </span>
<span></span>
<span><span class="va">balance_stats.cbps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                    outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                    balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                    home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using short formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-20-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-20-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-20-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 6 out of 12 (50%) covariates across time points, corresponding to 4 out of 4 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.15 (range= -0.36-0.28):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using cbps and short formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          1|            4|  5|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the short formulas and cbps :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.08 (range = -0.36 -0.28). </span></span>
<span><span class="co">#&gt; As shown below, the following 6 covariates across time points out of 12 total (50%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.15 (range=-0.36-0.28) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |4  |ESETA1   |       15|          0|gov_assist    | -0.3615020|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.1668682|       0.05|        0|</span></span>
<span><span class="co">#&gt; |9  |ESETA1   |       24|          0|gov_assist    |  0.2819245|       0.10|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|         15|InRatioCor.15 |  0.1316896|       0.05|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|          0|peri_health   |  0.1129432|       0.10|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|         15|WndNbrhood.15 | -0.1205542|       0.10|        0|</span></span></code></pre>
<p>For the CBPS weighting method, … <br></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.glm</span></span>
<span></span>
<span><span class="va">balance_stats.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                   outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                   balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                   home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using short formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-21-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-21-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-21-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 5 out of 12 (42%) covariates across time points, corresponding to 4 out of 4 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.14 (range= -0.21-0.19):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using glm and short formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          1|            1|  2|</span></span>
<span><span class="co">#&gt; |       15|          5|            0|  5|</span></span>
<span><span class="co">#&gt; |       24|          1|            4|  5|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the short formulas and glm :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.07 (range = -0.21 -0.19). </span></span>
<span><span class="co">#&gt; As shown below, the following 5 covariates across time points out of 12 total (41.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.14 (range=-0.21-0.19) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |1  |ESETA1   |        6|          0|gov_assist    |  0.1411332|       0.10|        0|</span></span>
<span><span class="co">#&gt; |9  |ESETA1   |       24|          0|gov_assist    |  0.1856165|       0.10|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|         15|InRatioCor.15 |  0.0898349|       0.05|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|          0|peri_health   |  0.1086854|       0.10|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|         15|WndNbrhood.15 | -0.2096705|       0.10|        0|</span></span></code></pre>
<p>For the GLM weighting method, … <br></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.gbm</span></span>
<span></span>
<span><span class="va">balance_stats.gbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                   outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                   balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                   home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using short formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-22-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-22-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-22-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 5 out of 12 (42%) covariates across time points, corresponding to 4 out of 4 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.2 (range= -0.3-0.24):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using gbm and short formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          1|            1|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          3|            2|  5|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the short formulas and gbm :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.09 (range = -0.3 -0.24). </span></span>
<span><span class="co">#&gt; As shown below, the following 5 covariates across time points out of 12 total (41.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.2 (range=-0.3-0.24) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |2  |ESETA1   |        6|          0|peri_health   |  0.1996984|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.1284153|       0.05|        0|</span></span>
<span><span class="co">#&gt; |6  |ESETA1   |       15|          0|peri_health   |  0.1069751|       0.10|        0|</span></span>
<span><span class="co">#&gt; |9  |ESETA1   |       24|          0|gov_assist    |  0.2447816|       0.10|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|         15|WndNbrhood.15 | -0.2978222|       0.10|        0|</span></span></code></pre>
<p>For the GBM weighting method, … <br></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.bart</span></span>
<span></span>
<span><span class="va">balance_stats.bart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                    outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                    balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                    home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using short formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-23-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-23-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-23-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 5 out of 12 (42%) covariates across time points, corresponding to 3 out of 4 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.14 (range= -0.29-0.18):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using bart and short formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          0|            2|  2|</span></span>
<span><span class="co">#&gt; |       15|          5|            0|  5|</span></span>
<span><span class="co">#&gt; |       24|          2|            3|  5|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the short formulas and bart :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.05 (range = -0.29 -0.18). </span></span>
<span><span class="co">#&gt; As shown below, the following 5 covariates across time points out of 12 total (41.67%) spanning 3 domains out of 5 (60%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.14 (range=-0.29-0.18) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |1  |ESETA1   |        6|          0|gov_assist    |  0.1402336|        0.1|        0|</span></span>
<span><span class="co">#&gt; |2  |ESETA1   |        6|          0|peri_health   |  0.1034089|        0.1|        0|</span></span>
<span><span class="co">#&gt; |9  |ESETA1   |       24|          0|gov_assist    |  0.1832490|        0.1|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|          0|peri_health   |  0.1015443|        0.1|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|         15|WndNbrhood.15 | -0.2853593|        0.1|        0|</span></span></code></pre>
<p>For the BART weighting method, … <br></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.super</span> </span>
<span></span>
<span><span class="va">balance_stats.super</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                     outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                     balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                     home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using short formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-24-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-24-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-24-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 5 out of 12 (42%) covariates across time points, corresponding to 4 out of 4 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.13 (range= -0.21-0.13):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using super and short formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          2|            3|  5|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the short formulas and super :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.09 (range = -0.21 -0.13). </span></span>
<span><span class="co">#&gt; As shown below, the following 5 covariates across time points out of 12 total (41.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.13 (range=-0.21-0.13) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |6  |ESETA1   |       15|          0|peri_health   | -0.1905116|       0.10|        0|</span></span>
<span><span class="co">#&gt; |7  |ESETA1   |       15|          6|WndNbrhood.6  |  0.1139114|       0.10|        0|</span></span>
<span><span class="co">#&gt; |9  |ESETA1   |       24|          0|gov_assist    |  0.1299789|       0.10|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|         15|InRatioCor.15 |  0.0548193|       0.05|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|         15|WndNbrhood.15 | -0.2069388|       0.10|        0|</span></span></code></pre>
<p>For the SuperLearner weighting method, … <br></p>
<p>The optimal weighting method for a dataset is the method that yields
the best confounder balance. From these iterations, we identify the best
performing weighting method that most reduces the imbalance between
exposure and confounder as indicated by the lowest median
correlation/standardized mean difference and the fewest number of
confounders left imbalanced.</p>
<p>In this example, …</p>
<p><br><br></p>
</div>
</div>
<div class="section level3">
<h3 id="step-3-create-updated-formulas-re-specify-weights-using-optimal-weighting-method">Step 3: Create Updated Formulas &amp; Re-Specify Weights Using
Optimal Weighting Method<a class="anchor" aria-label="anchor" href="#step-3-create-updated-formulas-re-specify-weights-using-optimal-weighting-method"></a>
</h3>
<p>The goal of this next step is to assess the the weights from the
best-performing weights method, created by the shortened balancing
formulas (containing time-varying confounders at only <em>t</em>-1),
relative to the full balancing formulas, and add to the shortened
formulas any time-varying confounders at lags &gt; <em>t</em>-1 that
were not successfully balanced to create a final round of weights.</p>
<p><br></p>
<div class="section level4">
<h4 id="step-3a--assess-balance-with-full-balancing-formulas">Step 3a. Assess balance with full balancing formulas<a class="anchor" aria-label="anchor" href="#step-3a--assess-balance-with-full-balancing-formulas"></a>
</h4>
<p>We next assess whether the weights created in the previous step with
the best-performing weights method (e.g., x) using the simplified
balancing formulas also achieve balance for all of the confounders in
the full formulas. We use the <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function
(<code>type = “weighted”</code>) with the full balancing formulas to
examine how successfully the best-performing weights created in the
previous step achieve balance for all time-varying confounders. We
revisit our assumption that balancing on the most proximal time-varying
confounders (<em>t</em>-1) confers balance for those same confounders at
more distal prior time points (<em>t</em>-1+). We do this by assessing
at each time point how well the weights just created using the short
formulas successfully balance all confounders (including time-varying
confounders at all time points prior) in the original, full
formulas.</p>
<p>The required inputs for using the <code><a href="../reference/assessBalance.html">assessBalance()</a></code>
function to assess how the best weights achieve balance for the full
formulas are: data (data frame, mids object, or a list of imputed
datasets as dataframes in wide format), exposure (e.g., “variable”),
exposure time points, outcome (e.g., “variable.time”), providing the
full formulas (see Step 1a), setting type = “weighted”, and providing
the best weights (see Step 2c).</p>
<p>The optional inputs are detailed in Step 1b.</p>
<p>The <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function saves out the following
.csv and .html files into the ‘balance/weighted’ folder: tables of
balance statistics for all confounders, tables of balance statistics for
covariates that are imbalanced, and an overall balance summary table
(averaged across any imputed datasets). Within the ‘balance/type/plots’
folder, the function outputs .jpeg files of summary love plots depicting
confounder balance for each exposure time point.</p>
<p>The function returns a data frame (or list) of balance statistics,
balance thresholds, and binary balanced tag for each confounder relevant
to each exposure time point.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"weighted"</span></span>
<span></span>
<span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="va">full_formulas</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">weights.cbps</span></span>
<span></span>
<span><span class="va">balance_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                               outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                               balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using full formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-25-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-25-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-25-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 7 out of 15 (47%) covariates across time points, corresponding to 4 out of 5 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.17 (range= -0.36-0.28):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using cbps and full formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          3|            5|  8|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the full formulas and cbps :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.06 (range = -0.36 -0.28). </span></span>
<span><span class="co">#&gt; As shown below, the following 7 covariates across time points out of 15 total (46.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.17 (range=-0.36-0.28) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |4  |ESETA1   |       15|          0|gov_assist    | -0.3615020|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.1668682|       0.05|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|          0|gov_assist    |  0.2819245|       0.10|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|         15|InRatioCor.15 |  0.1316896|       0.05|        0|</span></span>
<span><span class="co">#&gt; |13 |ESETA1   |       24|          0|peri_health   |  0.1129432|       0.10|        0|</span></span>
<span><span class="co">#&gt; |14 |ESETA1   |       24|         15|WndNbrhood.15 | -0.1205542|       0.10|        0|</span></span>
<span><span class="co">#&gt; |15 |ESETA1   |       24|          6|WndNbrhood.6  |  0.1654400|       0.10|        0|</span></span></code></pre>
<p>Using the x weighting method and the full formulas, we find…</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="step-3b--update-simplified-formulas">Step 3b. Update simplified formulas<a class="anchor" aria-label="anchor" href="#step-3b--update-simplified-formulas"></a>
</h4>
<p>Subsequently, we create a final round of balancing formulas using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function (setting
<code>type = “update"</code> and providing the balance statistics of the
<code>bal_stats</code> field). We update the shortened formulas to
include any time-varying confounders (<em>t</em>-1 +) that were not
successfully balanced by the weights created using the original
simplified formulas. The <code><a href="../reference/createFormulas.html">createFormulas()</a></code> function draws
from user-provided balance statistics to automatically identify and add
to the formulas at each exposure time point any time-varying confounders
at lags greater than 1 that remain imbalanced after weighting. The
function displays each balancing formula in the console with a message
to the user about any time-varying confounders that were added.</p>
<p>The required input to update the shortened balancing formulas with
any imbalanced time-varying confounders at greater lags using the
<code><a href="../reference/createFormulas.html">createFormulas()</a></code> function are: exposure (e.g., “variable”),
exposure time points, outcome (e.g., “variable.time”), a list of
time-varying confounders (e.g., “variable.time”), a list of time
invariant confounders, setting <code>type = “update”</code>, and
providing to <code>bal_stats</code> the balance statistics that were
just created.</p>
<p>The optional input are detailed in Step 1a.</p>
<p>The <code><a href="../reference/createFormulas.html">createFormulas()</a></code> function saves out .csv and .rds
files containing balancing formulas at each exposure time point for the
specified type in the ‘formulas/update’ folder.</p>
<p>The function returns a list of balancing formulas labeled by type,
exposure, outcome, and exposure time point.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"update"</span></span>
<span></span>
<span><span class="va">bal_stats</span> <span class="op">&lt;-</span> <span class="va">balance_stats</span></span>
<span></span>
<span><span class="va">updated_formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createFormulas.html">createFormulas</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, <span class="co">#required</span></span>
<span>                                   type <span class="op">=</span> <span class="va">type</span>, ti_confounders <span class="op">=</span> <span class="va">ti_confounders</span>, tv_confounders <span class="op">=</span> <span class="va">tv_confounders</span>, bal_stats <span class="op">=</span> <span class="va">bal_stats</span>, <span class="co">#required</span></span>
<span>                                   concur_conf <span class="op">=</span> <span class="va">concur_conf</span>, keep_conf <span class="op">=</span> <span class="va">keep_conf</span>, <span class="co">#optional</span></span>
<span>                                   home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the updated balancing formula below that includes time-varying confounders at t-1 and those greater at further lags that remained imbalanced:</span></span>
<span><span class="co">#&gt; The update formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 6 is: </span></span>
<span><span class="co">#&gt; ESETA1.6 ~ gov_assist + peri_health</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555ca989c440&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the updated balancing formula below that includes time-varying confounders at t-1 and those greater at further lags that remained imbalanced:</span></span>
<span><span class="co">#&gt; For ESETA1 at exposure time point 15 no time-varying confounders at additional lags were added. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The update formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 15 is: </span></span>
<span><span class="co">#&gt; ESETA1.15 ~ ESETA1.6 + gov_assist + InRatioCor.6 + peri_health + </span></span>
<span><span class="co">#&gt;     WndNbrhood.6</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555ca989c440&gt;</span></span>
<span><span class="co">#&gt; USER ALERT: Please manually inspect the updated balancing formula below that includes time-varying confounders at t-1 and those greater at further lags that remained imbalanced:</span></span>
<span><span class="co">#&gt; For ESETA1 at exposure time point 24 the following covariate(s) will be added to the short balancing formula:</span></span>
<span><span class="co">#&gt;                           WndNbrhood.6 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The update formula for ESETA1 - StrDif_Tot.58 at ESETA1 time point 24 is: </span></span>
<span><span class="co">#&gt; ESETA1.24 ~ ESETA1.15 + gov_assist + InRatioCor.15 + peri_health + </span></span>
<span><span class="co">#&gt;     WndNbrhood.15 + WndNbrhood.6</span></span>
<span><span class="co">#&gt; &lt;environment: 0x555ca989c440&gt;</span></span></code></pre></div>
<p><br></p>
</div>
<div class="section level4">
<h4 id="step-3c--create-final-balancing-weights">Step 3c. Create final balancing weights<a class="anchor" aria-label="anchor" href="#step-3c--create-final-balancing-weights"></a>
</h4>
<p>Next, we create a final set of balancing weights using the optimal
weighting method identified in Step 2c and the final, updated simplified
formulas from the previous step using the <code><a href="../reference/createWeights.html">createWeights()</a></code>
function (<code>method = “x’</code>), with ‘x’ being the optimal
weighting method identified in Step 2c. The function calls the
<code>weightitMSM()</code> function from the <em>WeightIt</em> package
(Greifer, 2023) that uses the time-specific formulas to create weights
at each time point and automatically multiplies them together to create
one weight per person. Weights are stabilized, as is recommended (Cole
&amp; Hernan, 2008; Thoemmes &amp; Ong, 2016) and distributions are
saved out in the home directory for inspection.</p>
<p>The required inputs for using the <code><a href="../reference/createWeights.html">createWeights()</a></code>
function to create the final round of IPTW balancing weights using the
updated short balancing formulas are: data (data frame, mids object, or
a list of imputed datasets as dataframes in wide format), exposure
(variable with no time points), outcome (e.g., “variable.time”),
providing the best-performing weights method, and providing the updated
formulas (see Step 3a).</p>
<p>The optional input for the <code><a href="../reference/createWeights.html">createWeights()</a></code> function are
listed in Step 2b.</p>
<p>The <code>createWeights</code> function saves out an .rds file of the
weights in the ‘weights’ folder, a histogram of the weights distribution
in the ‘weights/histograms’ folder, and a .csv file of data with the
weights appended in the ‘weights/values/’ folder.</p>
<p>The function returns a list of weights objects each in the form of
WeightItMSM output a list of weights with either a single nested list
(labeled “0” if data are in data frame format) or with nested lists for
each imputed dataset (if data are imputed).</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="va">updated_formulas</span></span>
<span></span>
<span><span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"cbps"</span></span>
<span></span>
<span><span class="co">#all inputs</span></span>
<span><span class="va">final_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createWeights.html">createWeights</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, <span class="co">#required</span></span>
<span>                               method <span class="op">=</span> <span class="va">method</span>, read_in_from_file <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; For the cbps weighting method, the median weight value is 0.87 (SD = 1.47; range = 0.1-8).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="d--trim-final-balancing-weights">3d. Trim final balancing weights<a class="anchor" aria-label="anchor" href="#d--trim-final-balancing-weights"></a>
</h4>
<p>The next step is to trim or winsorize this final set of weights to
eliminate the heavy right tail of its distribution using the
<code><a href="../reference/trimWeights.html">trimWeights()</a></code> function that draws on the <em>Weightit</em>
package (Griefer, 2023) and then plots and summarizes trimmed weights.
This function outputs a list of trimmed weights with either a single
nested list (labeled “0” if data are in data frame format) or with
nested lists for each imputed dataset (if data are imputed).</p>
<p>The required inputs for the <code><a href="../reference/trimWeights.html">trimWeights()</a></code> function are:
the exposure (variable with no time points), outcome (e.g.,
“variable.time”), and the final weights we just created.</p>
<p>The optional inputs are as follows. The user has the option to
specify a quantile value (0-1; default is 0.95) above which the weights
will be replaced with the weight value of that quantile to reduce the
heavy right tail.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantile</span> <span class="op">&lt;-</span> <span class="fl">0.95</span> </span></code></pre></div>
<p>The <code>trimWeights</code> function saves out an .rds file of
trimmed weights in the ‘weights/values’ folder and a histogram of
trimmed weights (Figure x) in the ‘weights/histograms’ folder.</p>
<p>The function returns a list of weights objects, containing trimmed
weights, each in the form of weightitMSM output.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">final_weights</span></span>
<span></span>
<span><span class="va">trim_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimWeights.html">trimWeights</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                            quantile <span class="op">=</span> <span class="va">quantile</span>, <span class="co">#optional</span></span>
<span>                            home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Trimming weights to 95%.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For the ESETA1-StrDif_Tot.58 relation, following trimming at the 0.95 quantile, the median weight value is 0.87 (SD= 1.21; range= 0.1-5).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<p>We then create trimmed weights using two other quantile values at +
/- ~0.3 of the previously chosen quantile value in order to conduct the
recommended sensitivity analyses at subsequent steps.</p>
<p>We first create weights at the 92nd quantile value.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantile</span> <span class="op">&lt;-</span> <span class="fl">0.92</span> </span>
<span></span>
<span><span class="va">trim_weights.s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimWeights.html">trimWeights</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                               quantile <span class="op">=</span> <span class="va">quantile</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Trimming weights to 92%.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For the ESETA1-StrDif_Tot.58 relation, following trimming at the 0.92 quantile, the median weight value is 0.87 (SD= 0.75; range= 0.1-3).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<p>And then at the 98th quantile value.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantile</span> <span class="op">&lt;-</span> <span class="fl">0.98</span> </span>
<span></span>
<span><span class="va">trim_weights.s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trimWeights.html">trimWeights</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                               quantile <span class="op">=</span> <span class="va">quantile</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Trimming weights to 98%.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For the ESETA1-StrDif_Tot.58 relation, following trimming at the 0.98 quantile, the median weight value is 0.87 (SD= 1.28; range= 0.1-6).</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<p>We find comparable descriptive statistics for all sets of weights,
with the upper range value varying by quantile cutoff. All sets of
weights have heavy right tails, as expected with real-world data. These
tails represent individuals who experienced statistically unexpected
levels of exposure given their levels of confounders.</p>
<p><br></p>
</div>
</div>
<div class="section level3">
<h3 id="step-4-conduct-final-balance-assessment">Step 4: Conduct Final Balance Assessment<a class="anchor" aria-label="anchor" href="#step-4-conduct-final-balance-assessment"></a>
</h3>
<p>Having created and trimmed the finalized set of IPTW balancing
weights, the next step is to conduct a final evaluation of how well they
reduce imbalance for all possible confounders. We assess the performance
of the final weights from the previous step using
<code><a href="../reference/assessBalance.html">assessBalance()</a></code> function (<code>type = “weighted”</code>)
and the full formulas.</p>
<p>The required inputs for using the <code><a href="../reference/assessBalance.html">assessBalance()</a></code>
function to assess how the final, trimmed weights achieve balance for
the full formulas are: data (data frame, mids object, or a list of
imputed datasets as dataframes in wide format), exposure (e.g.,
“variable”), exposure time points, outcome (e.g., “variable.time”), and
provide the full formulas (see Step 1a), set type = “weighted”, and
provide the final, trimmed weights (see Step 3b).</p>
<p>The optional inputs for the <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function are
detailed in Step 1b.</p>
<p>The <code><a href="../reference/assessBalance.html">assessBalance()</a></code> function saves out the following
.csv and .html files into the ‘balance/weighted’ folder: tables of
balance statistics for all confounders, tables of balance statistics for
covariates that are imbalanced, and an overall balance summary table
(averaged across any imputed datasets). Within the
‘balance/weighted/plots’ folder, the function outputs .jpeg files of
summary love plots depicting confounder balance for each exposure time
point.</p>
<p>The function returns a data frame (or list) of balance statistics,
balance thresholds, and binary balanced tag for each confounder relevant
to each exposure time point.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"weighted"</span></span>
<span></span>
<span><span class="va">formulas</span> <span class="op">&lt;-</span> <span class="va">full_formulas</span></span>
<span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights</span></span>
<span></span>
<span><span class="va">final_balance_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                     outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                     balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                     home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using full formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-32-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-32-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-32-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 7 out of 15 (47%) covariates across time points, corresponding to 4 out of 5 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.12 (range= -0.23-0.21):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using cbps and full formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          3|            5|  8|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the full formulas and cbps :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.05 (range = -0.23 -0.21). </span></span>
<span><span class="co">#&gt; As shown below, the following 7 covariates across time points out of 15 total (46.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.12 (range=-0.23-0.21) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |4  |ESETA1   |       15|          0|gov_assist    | -0.2349927|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.1723677|       0.05|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|          0|gov_assist    |  0.2071789|       0.10|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|         15|InRatioCor.15 |  0.1031997|       0.05|        0|</span></span>
<span><span class="co">#&gt; |13 |ESETA1   |       24|          0|peri_health   |  0.1039243|       0.10|        0|</span></span>
<span><span class="co">#&gt; |14 |ESETA1   |       24|         15|WndNbrhood.15 | -0.1010483|       0.10|        0|</span></span>
<span><span class="co">#&gt; |15 |ESETA1   |       24|          6|WndNbrhood.6  |  0.1231975|       0.10|        0|</span></span></code></pre>
<p>From this assessment, we find…</p>
<p>At this step, the user must manually list out any confounders that
are time invariant or measured at the first time point (6 months) that
remain imbalanced following this final balance assessment as
<code>covariates</code>. These can be supplied when selecting a
covariate model in Step 5 to account for remaining confounding.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ESETA1.6"</span>, <span class="st">"gov_assist"</span><span class="op">)</span><span class="co"># "B18Raw.6") </span></span></code></pre></div>
<p>We also assess balance for the weights trimmed at the two additional
quantile values to assess whether the final balance assessment is
sensitive to the trim value. Importantly, if
<code>save.out = TRUE</code>, running these analyses will overwrite the
output from the main history comparison above if the main output is not
rename or re-located to a new folder first. Additionally, after running
the first sensitivity check, the output from that check will be
overwritten by the second sensitivity check if it is not renamed or
re-located to a new folder first.</p>
<p>We first assess balance for the weights trimmed at the 93rd quantile
value.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights.s1</span></span>
<span></span>
<span><span class="va">final_balance_stats.s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                        outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                        balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                        home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using full formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-34-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-34-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-34-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 8 out of 15 (53%) covariates across time points, corresponding to 4 out of 5 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.12 (range= -0.16-0.19):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using cbps and full formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          2|            6|  8|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the full formulas and cbps :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.06 (range = -0.16 -0.19). </span></span>
<span><span class="co">#&gt; As shown below, the following 8 covariates across time points out of 15 total (53.33%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.12 (range=-0.16-0.19) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |4  |ESETA1   |       15|          0|gov_assist    | -0.1186420|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.0868579|       0.05|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|          0|gov_assist    |  0.1852746|       0.10|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|         15|InRatioCor.15 |  0.1037520|       0.05|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|          6|InRatioCor.6  | -0.0553485|       0.05|        0|</span></span>
<span><span class="co">#&gt; |13 |ESETA1   |       24|          0|peri_health   |  0.1157074|       0.10|        0|</span></span>
<span><span class="co">#&gt; |14 |ESETA1   |       24|         15|WndNbrhood.15 | -0.1576152|       0.10|        0|</span></span>
<span><span class="co">#&gt; |15 |ESETA1   |       24|          6|WndNbrhood.6  |  0.1152603|       0.10|        0|</span></span></code></pre>
<p>From this, we find…</p>
<p>We next assess balance for the weights trimmed at the 98th quantile
value.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights.s2</span></span>
<span></span>
<span><span class="va">final_balance_stats.s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assessBalance.html">assessBalance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, <span class="co">#required</span></span>
<span>                                        outcome <span class="op">=</span> <span class="va">outcome</span>, type <span class="op">=</span> <span class="va">type</span>, formulas <span class="op">=</span> <span class="va">formulas</span>, weights <span class="op">=</span> <span class="va">weights</span>, <span class="co">#required</span></span>
<span>                                        balance_thresh <span class="op">=</span> <span class="va">balance_thresh</span>, imp_conf <span class="op">=</span> <span class="va">imp_conf</span>, <span class="co">#optional</span></span>
<span>                                        home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; USER ALERT: The following statistics display covariate imbalance at each exposure time point following IPTW weighting, using full formulas.</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-35-1.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-35-2.png" width="700"><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-35-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; As shown below, 7 out of 15 (47%) covariates across time points, corresponding to 4 out of 5 domains, remain imbalanced with a remaining median absolute value correlation/std mean difference of 0.12 (range= -0.26-0.21):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced covariates using cbps and full formulas</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; | exp_time| balanced_n| imbalanced_n|  n|</span></span>
<span><span class="co">#&gt; |--------:|----------:|------------:|--:|</span></span>
<span><span class="co">#&gt; |        6|          2|            0|  2|</span></span>
<span><span class="co">#&gt; |       15|          3|            2|  5|</span></span>
<span><span class="co">#&gt; |       24|          3|            5|  8|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: For exposure ESETA1 using the full formulas and cbps :</span></span>
<span><span class="co">#&gt; The median absolute value relation between exposure and confounder is 0.05 (range = -0.26 -0.21). </span></span>
<span><span class="co">#&gt; As shown below, the following 7 covariates across time points out of 15 total (46.67%) spanning 4 domains out of 5 (80%) are imbalanced with a remaining median absolute value correlation/std mean difference in relation to ESETA1 of 0.12 (range=-0.26-0.21) :</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Imbalanced Covariates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |   |exposure | exp_time| covar_time|covariate     |    avg_bal| bal_thresh| balanced|</span></span>
<span><span class="co">#&gt; |:--|:--------|--------:|----------:|:-------------|----------:|----------:|--------:|</span></span>
<span><span class="co">#&gt; |4  |ESETA1   |       15|          0|gov_assist    | -0.2580106|       0.10|        0|</span></span>
<span><span class="co">#&gt; |5  |ESETA1   |       15|          6|InRatioCor.6  |  0.1867061|       0.05|        0|</span></span>
<span><span class="co">#&gt; |10 |ESETA1   |       24|          0|gov_assist    |  0.2112737|       0.10|        0|</span></span>
<span><span class="co">#&gt; |11 |ESETA1   |       24|         15|InRatioCor.15 |  0.1036528|       0.05|        0|</span></span>
<span><span class="co">#&gt; |12 |ESETA1   |       24|          6|InRatioCor.6  | -0.0502576|       0.05|        0|</span></span>
<span><span class="co">#&gt; |13 |ESETA1   |       24|          0|peri_health   |  0.1044737|       0.10|        0|</span></span>
<span><span class="co">#&gt; |15 |ESETA1   |       24|          6|WndNbrhood.6  |  0.1238537|       0.10|        0|</span></span></code></pre>
<p>From this, we find…</p>
<p>Overall, the sensitivity analyses indicate….</p>
<p><br><br></p>
</div>
</div>
<div class="section level2">
<h2 id="phase-2-assess-substantive-associations-between-exposure-outcome">Phase 2: Assess Substantive Associations between Exposure &amp;
Outcome<a class="anchor" aria-label="anchor" href="#phase-2-assess-substantive-associations-between-exposure-outcome"></a>
</h2>
<p>Having created IPTW balancing weights that minimize or attentuate
associations between confounders and exposure at each time point, we can
move to the substantive modeling phase.<br><br></p>
<div class="section level3">
<h3 id="step-5-fit-marginal-structural-model-summarize-visualize-results">Step 5: Fit Marginal Structural Model &amp; Summarize &amp;
Visualize Results<a class="anchor" aria-label="anchor" href="#step-5-fit-marginal-structural-model-summarize-visualize-results"></a>
</h3>
<p>The goal of this final step is to fit a weighted model of the user’s
choosing relating exposure at meaningful epochs of developmental time to
the outcome, before summarizing and visualizing the results. In this
step, the user models and compares various counterfactuals, or the
effects of different developmental histories of exposure on the outcome,
to test their substantive hypotheses about dose and timing.<br><br></p>
<div class="section level4">
<h4 id="step-5a--select-fit-a-marginal-outcome-model">Step 5a. Select &amp; fit a marginal outcome model<a class="anchor" aria-label="anchor" href="#step-5a--select-fit-a-marginal-outcome-model"></a>
</h4>
<p>First, we use the <code><a href="../reference/fitModel.html">fitModel()</a></code> function to fit a weighted
generalized linear model of the user’s choosing relating exposure to
outcome. The function draws on the <code>svyglm()</code> function of the
<em>survey</em> package (Lumley, 2023). If the user specifies exposure
epochs, exposure levels are averaged for any epochs that consist of two
or more time point values. One of the benefits of creating balancing
weights is that they can be used in a variety of different marginal
outcome models and those encompassed in this function are only a subset
of possible models. Note that these models can get complex and we do not
advise interpreting the individual terms.</p>
<p>The required inputs for using the <code><a href="../reference/fitModel.html">fitModel()</a></code> function
are: data (data frame, mids object, or a list of imputed datasets as
dataframes in wide format), exposure (e.g., “variable”), exposure time
points, outcome (e.g., “variable.time”), a list of trimmed weights, and
a model from the list below (“m0”, “m1”, “m2”, or “m3”):</p>
<ul>
<li><p><em>M0</em>: Baseline model regressing the outcome on the main
effects of exposure (e.g., infancy, toddlerhood, childhood).</p></li>
<li><p><em>M1</em>: Covariate model regressing the outcome on the main
effects of exposure, as well as user-specified covariates (e.g.,
confounders measured at baseline or the first time point that remained
imbalanced after weighting in Step 4).</p></li>
<li><p><em>M2</em>: Interaction model regressing the outcome on the main
effects of exposure, as well as all user-specified interactions between
exposure main effects (e.g., infancy:toddlerhood)</p></li>
<li><p><em>M3</em>: Full model regressing the outcome on the main
effects of exposure, user-specified covariates, as well as all
user-specified exposure main effect interactions.</p></li>
</ul>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"m2"</span></span></code></pre></div>
<p>If you select a covariate model (“m1” or “m3”), you are required to
supply a list to <code>covariates</code> that corresponds to covariates
in your wide data that you wish to adjust for. Here, we recommend
including any confounders that remain imbalanced at the final balance
assessment (Step 4) and are time-invariant or measured at the first time
point.</p>
<p>If you select an interaction model (“m2” or “m3”), you are required
to provide a interaction order integer in the <code>int_order</code>
field that reflects the maximum interaction (e.g., 3) (that will
automatically include all lower order interactions (e.g., 2-way)). The
interaction order cannot exceed the number of exposure main effects.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">int_order</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">int_order</span> <span class="op">&lt;-</span> <span class="fl">2</span></span></code></pre></div>
<p>The optional inputs to the <code><a href="../reference/fitModel.html">fitModel()</a></code> function are as
follows.</p>
<p>The user has the option to specify epochs that differ from the
measurement time points using the optional <code>epochs</code> data
frame field. For epochs: provide a list of user-created names in
quotations (that each constitute a meaningful developmental time period
that will constitute time units for your exposure histories); for
values: as a list, for each epoch, provide a single integer or a list of
integers from the time points at which exposure was measured that
constitute that epoch. If no epochs are specified, the time points at
which exposure was measured will be used in the creation of exposure
histories in the final step of the process. Each specified epoch must
have a corresponding value (but the values can differ in number of
entries as shown below). Epochs must be specified in this step if they
will be used in the subsequent step comparing histories, and the
specification of exposure epochs should be kept consistent throughout
the use of the <em>devMSMs</em> package.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epochs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>epochs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Infancy"</span>, <span class="st">"Toddlerhood"</span>, <span class="st">"Childhood"</span><span class="op">)</span>, </span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>The user can also specify a <code>family</code> (as a function, not
in quotations; e.g., gaussian) and <code>link</code> (in quotations,
e.g., “link”) functions for the generalized linear model (defaults are
gaussian and “link”, respectively). The possible families are: binomial,
gaussian, Gama, inverse.gaussian, poisson, quasi, quasibinomial, and
quasipoisson. For binomial and Poisson families, set family to
quasibinomial and quasipoisson, respectively, to avoid a warning about
non-integer numbers of successes. The `quasi’ versions of the family
objects give the same point estimates and standard errors and do not
give the warning. The gaussian family accepts the links: “identity”,
“log” and “inverse”; the binomial family the links “logit”, “probit”,
“cauchit”, (corresponding to logistic, normal and Cauchy CDFs
respectively) “log” and “cloglog” (complementary log-log); the Gamma
family the links “inverse”, “identity”, and “log”; the poisson family
the links “log”, “identity”, and “sqrt”; and the inverse.gaussian family
the links 1/mu^2, inverse, identity and log. The quasi family accepts
the links “logit”, “probit”, “cloglog”, “identity”, “inverse”, “log”,
“1/mu^2”, and “sqrt”, and the function power can be used to create a
power link function. See the <em>survey</em> and <em>stats</em> R
package documentations for more information.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">family</span> <span class="op">&lt;-</span> <span class="va">gaussian</span></span>
<span></span>
<span><span class="va">link</span> <span class="op">&lt;-</span> <span class="st">"identity"</span> </span></code></pre></div>
<p>The <code><a href="../reference/fitModel.html">fitModel()</a></code> function outputs a .rds file of the
fitted model(s) and a .html table of model evidence (can display models
for up to 12 imputed datasets) in the ‘models’ folder.</p>
<p>Importantly, this function also outputs into the console the result
of a likelihood ratio test comparing the user-specified model to a
nested version of that model that omits all exposure variables to test
whether exposure predicts variation in the outcome. If this test is not
significant and there is no evidence that exposure predicts outcome, we
do not advise proceeding to the subsequent history comparison step.
Models are pooled prior to conducting the likelihood ratio test for
imputed data.</p>
<p>This function returns a list of fitted model objects, each as svyglm
output (labeled “0” if data are in data frame format).</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights</span></span>
<span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitModel.html">fitModel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, weights <span class="op">=</span> <span class="va">weights</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, <span class="co">#required</span></span>
<span>                   exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                   family <span class="op">=</span> <span class="va">family</span>, link <span class="op">=</span> <span class="va">link</span>, int_order <span class="op">=</span> <span class="va">int_order</span>, covariates <span class="op">=</span> <span class="va">covariates</span>, epochs <span class="op">=</span> <span class="va">epochs</span>, <span class="co">#optional</span></span>
<span>                   home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Please inspect the following likelihood ratio test to determine if the exposures collective predict significant variation in the outcome compared to a model without exposure terms.</span></span>
<span><span class="co">#&gt; We strongly suggest not conducting history comparisons if the likelihood ratio test is non-significant.</span></span>
<span><span class="co">#&gt; Working (Rao-Scott+F) LRT for ESETA1.Infancy ESETA1.Toddlerhood ESETA1.Childhood ESETA1.Infancy:ESETA1.Toddlerhood ESETA1.Infancy:ESETA1.Childhood ESETA1.Toddlerhood:ESETA1.Childhood</span></span>
<span><span class="co">#&gt;  in svyglm(formula = as.formula(f), design = s, family = fam)</span></span>
<span><span class="co">#&gt; Working 2logLR =  14.36054 p= 0.053537 </span></span>
<span><span class="co">#&gt; (scale factors:  1.9 1.3 1.1 0.8 0.5 0.38 );  denominator df= 43</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The marginal model, m2, is summarized below:</span></span></code></pre></div>
<p>We find, …</p>
<p>We then conduct sensitivity analyses fitting the model with weights
that were trimmed at two different values. Of note, as described in Step
4, if <code>save.out = TRUE</code>, running these analyses will
overwrite the output from the main model fitting above if the main
output is not rename or re-located to a new folder first.</p>
<p>We first fit the same model to the weights trimmed at the 92nd
quantile.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights.s1</span></span>
<span></span>
<span><span class="va">models.s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitModel.html">fitModel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, weights <span class="op">=</span> <span class="va">weights</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, <span class="co">#required</span></span>
<span>                      exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                      family <span class="op">=</span> <span class="va">family</span>, link <span class="op">=</span> <span class="va">link</span>, int_order <span class="op">=</span> <span class="va">int_order</span>, covariates <span class="op">=</span> <span class="va">covariates</span>, epochs <span class="op">=</span> <span class="va">epochs</span>, <span class="co">#optional</span></span>
<span>                      home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Please inspect the following likelihood ratio test to determine if the exposures collective predict significant variation in the outcome compared to a model without exposure terms.</span></span>
<span><span class="co">#&gt; We strongly suggest not conducting history comparisons if the likelihood ratio test is non-significant.</span></span>
<span><span class="co">#&gt; Working (Rao-Scott+F) LRT for ESETA1.Infancy ESETA1.Toddlerhood ESETA1.Childhood ESETA1.Infancy:ESETA1.Toddlerhood ESETA1.Infancy:ESETA1.Childhood ESETA1.Toddlerhood:ESETA1.Childhood</span></span>
<span><span class="co">#&gt;  in svyglm(formula = as.formula(f), design = s, family = fam)</span></span>
<span><span class="co">#&gt; Working 2logLR =  11.48889 p= 0.10914 </span></span>
<span><span class="co">#&gt; (scale factors:  1.7 1.5 1.1 0.81 0.52 0.39 );  denominator df= 43</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The marginal model, m2, is summarized below:</span></span></code></pre></div>
<p>We find, ….</p>
<p>We then fit the same model to the weights trimmed at the 98th
quantile.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">trim_weights.s2</span></span>
<span></span>
<span><span class="va">models.s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitModel.html">fitModel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, weights <span class="op">=</span> <span class="va">weights</span>, exposure <span class="op">=</span> <span class="va">exposure</span>, <span class="co">#required</span></span>
<span>                      exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                      family <span class="op">=</span> <span class="va">family</span>, link <span class="op">=</span> <span class="va">link</span>, int_order <span class="op">=</span> <span class="va">int_order</span>, covariates <span class="op">=</span> <span class="va">covariates</span>, epochs <span class="op">=</span> <span class="va">epochs</span>, <span class="co">#optional</span></span>
<span>                      home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Please inspect the following likelihood ratio test to determine if the exposures collective predict significant variation in the outcome compared to a model without exposure terms.</span></span>
<span><span class="co">#&gt; We strongly suggest not conducting history comparisons if the likelihood ratio test is non-significant.</span></span>
<span><span class="co">#&gt; Working (Rao-Scott+F) LRT for ESETA1.Infancy ESETA1.Toddlerhood ESETA1.Childhood ESETA1.Infancy:ESETA1.Toddlerhood ESETA1.Infancy:ESETA1.Childhood ESETA1.Toddlerhood:ESETA1.Childhood</span></span>
<span><span class="co">#&gt;  in svyglm(formula = as.formula(f), design = s, family = fam)</span></span>
<span><span class="co">#&gt; Working 2logLR =  14.96005 p= 0.046242 </span></span>
<span><span class="co">#&gt; (scale factors:  1.9 1.3 1.1 0.8 0.5 0.39 );  denominator df= 43</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The marginal model, m2, is summarized below:</span></span></code></pre></div>
<p>We find, ….</p>
<p>In general, from the sensitivity analyeses, we find…</p>
<p><br></p>
</div>
<div class="section level4">
<h4 id="step-5b--estimate-compare-and-visualize-model-predicted-outcome-as-a-function-of-exposure-history">Step 5b. Estimate, compare, and visualize model-predicted outcome as
a function of exposure history<a class="anchor" aria-label="anchor" href="#step-5b--estimate-compare-and-visualize-model-predicted-outcome-as-a-function-of-exposure-history"></a>
</h4>
<p>In this final step, we use the fitted model results to test
substantive hypotheses about dose and timing. We estimate and then
compare the average marginal estimates of the outcome for each
user-specified exposure history (i.e., permutation of high (“h) and low
(“l”) levels of exposure at each exposure epoch) using the
<code><a href="../reference/compareHistories.html">compareHistories()</a></code> function. This draws primarily from the
<code>avg_predictions()</code> and <code>hypotheses()</code> functions
in the <em>marginaleffects</em> package (Arel-Bundock, 2023).</p>
<p>First, this function creates average predictions of the outcome for
each exposure history. For each of the <em>n</em> combinations of
user-specified exposure histories, we set the value of those predictors
in the full dataset to the values in that combination, leaving all other
variables as they are. This gives us <em>n</em> datasets, each the same
size as our original dataset used to fit the model. For the <em>n</em>
datasets, we then compute the predicted values given the model before
taking the average predicted value for each of the <em>n</em> datasets.
These <em>n</em> averaged predicted values are the expected potential
outcomes under each combination. For imputed data, the function outputs
pooled predicted values using Rubin’s Rules.</p>
<p>Next, using the predicted values (per imputed dataset, where
applicable), the function conducts comparisons of the different
histories (pooling across imputed datasets for imputed data using
Rubin’s Rules). Lastly, the function implements correction for multiple
comparisons (treating each iteration of the function as a family) before
plotting the results. Box plots display outcome on the x-axis and
exposure history on the y-axis and whiskers display standard errors.</p>
<p>The required inputs for using the <code><a href="../reference/compareHistories.html">compareHistories()</a></code>
function are: exposure (e.g., “variable”), outcome (e.g., “variable.t”),
and a list of model output from Step 5a.</p>
<p>The optional inputs are as follows.</p>
<p>For continuous exposures, in <code>hi_lo_cut</code> the user can
specify a list of two quantile values (0-1; default is median split +/-
0.001) demarcating high and low levels of exposure, respectively.
Imputed data are stacked to calculate cutoff values. We suggest drawing
on existing hypotheses and examining the variability in the exposure
variable to determine high and low cutoffs. We recommend users begin by
specifying meaningful high and low percentile cutoffs and examining how
many individuals in the sample fall into each of the user-specified
exposure histories created by those percentile cutoffs (see Preliminary
Steps vignette). While there are no gold standard recommendations for
sufficient cell numbers per history, users should ensure that there is
is reasonable coverage in all of their histories to avoid extrapolation
and maximize precision.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hi_lo_cut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.3</span><span class="op">)</span> </span></code></pre></div>
<p>Additionally, the user has the option to specify epochs that differ
from the measurement time points using the optional <code>epochs</code>
data frame field (see Step 5a above). If you specified epochs in Step 5a
for the <code><a href="../reference/fitModel.html">fitModel()</a></code> function, you must specify them at this
step.</p>
<p>The user also has the option to estimate and compare only a custom
subset of user-specified exposure histories (i.e., sequences of high and
low levels of exposure at each epoch or time point) using the
<code>reference</code> and <code>comparison</code> fields. To conduct
these customized comparisons, users must provide at least one unique
valid history (e.g., “l-l-l”) as a reference by, in quotations, provide
a string (or a list of strings) of lowercase l’s and h’s (each separated
by -), each corresponding to each exposure epoch (or time point), that
signify the sequence of exposure levels (“low” or “high”, respectively).
If you supply a reference history, in comparisons provide at least one
unique and valid history for comparison by, in quotations, providing a
string (or list of strings) of l’s and h’s (each separated by “-”), with
each corresponding to each exposure epoch, that signify the sequence of
exposure levels (“low” or “high”, respectively) that constitutes the
comparison exposure history/histories to be compared to the reference.
If you supply one or more comparisons, at least one reference must be
specified. Each reference exposure history will be compared to each
comparison history and all comparisons will be supplied for multiple
comparison correction. If no reference or comparison is specified, all
histories will be compared to each other. If there are more than 4
exposure main effects (either as epochs or exposure time points), the
user is required to select a subset of history comparisons (Step 5b),
given that the base code (see the <code>hypotheses()</code> function
from the <em>marginaleffects</em> package; Arel-Bundock, 2023) cannot
accommodate all pairwise history comparisons for more than 5 time
points.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reference</span> <span class="op">&lt;-</span> <span class="st">"l-l-l"</span> </span>
<span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"h-h-h"</span>, <span class="st">"h-h-l"</span><span class="op">)</span> </span></code></pre></div>
<p>The user can also specify a multiple comparison method in
<code>mc_method</code> by in quotations, providing the shorthand for the
method (“holm”, “hochberg”,“hommel”, “bonferroni”, “BH”, “BY”, “fdr”, or
“n” (see stats::p.adjust documentation; R Core Team) for multiple
comparison correction to be applied to the final pooled contrasts
comparing effects of different exposure histories on outcome (default is
Benjamini-Hochburg). Each code run is considered a family. If the user
iterates through this function specifying different comparisons each
time, we strongly recommend interpreting the outcome of the most
inclusive set of comparisons to avoid false discovery.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mc_comp_method</span> <span class="op">&lt;-</span> <span class="st">"BH"</span></span></code></pre></div>
<p>Based on their substantive interests, the user also has the option to
choose which level of dosage (“h” or “l”) is tallied in labels of dose
counts in the tables and figures (<code>dose_level</code>; default is
“h”). For example, if the exposure variable was coded in such a way that
lower levels are conceptualized as the exposure (e.g., lower income),
the user may wish to choose dosage level “l”.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dose_level</span> <span class="op">&lt;-</span> <span class="st">"h"</span></span></code></pre></div>
<p>Lastly, the user can provide alternate plotting labels for exposure
and outcome in the exp_lab and out_lab fields (defaults are variable
names) as well as a list (equal to number of exposure main effects +1)
of colors or a Brewer color palette (colors; default is “Dark2”). See
RColorBrewer::display.brewer.all() or <a href="https://r-graph-gallery.com/38-rcolorbrewers-palettes.html" class="external-link uri">https://r-graph-gallery.com/38-rcolorbrewers-palettes.html</a>).</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp_lab</span> <span class="op">&lt;-</span> <span class="st">"Economic Strain"</span> <span class="co">#empirical example </span></span>
<span></span>
<span><span class="va">out_lab</span> <span class="op">&lt;-</span> <span class="st">"Behavior Problems"</span> <span class="co">#empirical example </span></span>
<span></span>
<span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue4"</span>, <span class="st">"darkgreen"</span>, <span class="st">"darkgoldenrod"</span>, <span class="st">"red2"</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/compareHistories.html">compareHistories()</a></code> function saves out .html tables
of the estimated mean outcome values for each history and history
comparisons in the ‘histories’ folder and a boxplot of predicted values
for the histories in the ‘plots’ folder.</p>
<p>The function returns a data frame of user-specified history
comparisons containing contrast estimates, standard errors, statistics,
p-values, low and high confidence intervals, and corrected p-values,
labeled by history and dose.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">models</span> </span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareHistories.html">compareHistories</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                            epochs <span class="op">=</span> <span class="va">epochs</span>, hi_lo_cut <span class="op">=</span> <span class="va">hi_lo_cut</span>, reference <span class="op">=</span> <span class="va">reference</span>, comparison <span class="op">=</span> <span class="va">comparison</span>, <span class="co">#optional</span></span>
<span>                            mc_comp_method <span class="op">=</span> <span class="va">mc_comp_method</span>, dose_level <span class="op">=</span> <span class="va">dose_level</span>, exp_lab <span class="op">=</span> <span class="va">exp_lab</span>, out_lab <span class="op">=</span> <span class="va">out_lab</span>, colors <span class="op">=</span> <span class="va">colors</span>, <span class="co">#optional</span></span>
<span>                            home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Summary of Exposure Main Effects: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: Out of the total of 50 individuals in the sample, below is the distribution of the 7 (14%) individuals that fall into 3 out of the 3 the total user-defined exposure histories created from 30th and 60th percentile values for low and high levels of exposure ESETA1, respectively, across Infancy, Toddlerhood, Childhood. </span></span>
<span><span class="co">#&gt; USER ALERT: Please inspect the distribution of the sample across the following exposure histories and ensure there is sufficient spread to avoid extrapolation and low precision: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Summary of user-specified exposure ESETA1 histories based on exposure main effects Infancy, Toddlerhood, Childhood containing time points 6, 15, 24:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |history |  n|</span></span>
<span><span class="co">#&gt; |:-------|--:|</span></span>
<span><span class="co">#&gt; |h-h-h   |  3|</span></span>
<span><span class="co">#&gt; |h-h-l   |  2|</span></span>
<span><span class="co">#&gt; |l-l-l   |  2|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Below are the average predictions by user-specified history: </span></span>
<span><span class="co">#&gt; |   | ESETA1.Infancy| ESETA1.Toddlerhood| ESETA1.Childhood| estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history | dose_count|</span></span>
<span><span class="co">#&gt; |:--|--------------:|------------------:|----------------:|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:-------|----------:|</span></span>
<span><span class="co">#&gt; |1  |        -0.5642|            -0.5331|          -0.4885|   0.0003|    0.1658|    0.0016|  0.9987|  0.0019|  -0.3247|    0.3252|l-l-l   |          0|</span></span>
<span><span class="co">#&gt; |4  |         0.4722|             0.0684|          -0.4885|   0.2119|    0.1650|    1.2840|  0.1991|  2.3281|  -0.1116|    0.5353|h-h-l   |          2|</span></span>
<span><span class="co">#&gt; |8  |         0.4722|             0.0684|           0.2449|   0.0384|    0.1658|    0.2317|  0.8167|  0.2920|  -0.2866|    0.3634|h-h-h   |          3|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Conducting multiple comparison correction for all pairings between comparison histories and each refernece history using the BH method. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: please inspect the following comparisons: </span></span>
<span><span class="co">#&gt; |term                                                    | estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history        |dose   | p.value_corr|</span></span>
<span><span class="co">#&gt; |:-------------------------------------------------------|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:--------------|:------|------------:|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, 0.2449)  |     0.04|      0.21|      0.18|    0.86|    0.22|    -0.38|      0.46|l-l-l vs h-h-h |0 vs 3 |         0.86|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, -0.4885) |     0.21|      0.18|      1.15|    0.25|    2.00|    -0.15|      0.57|l-l-l vs h-h-l |0 vs 2 |         0.50|</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-48-1.png" width="700"></p>
<p>We find, ….</p>
<p>We then conduct sensitivity analyses by assessing and comparing
histories drawing from models that used weights trimmed at two different
values. Of note, running these analyses will overwrite the output from
the main history comparison above if the main output is not rename or
re-located to a new folder first.</p>
<p>We first compare the same histories using the model fit with weights
trimmed at the 92nd quantile value.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">models.s1</span> </span>
<span></span>
<span><span class="va">results.s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareHistories.html">compareHistories</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                               epochs <span class="op">=</span> <span class="va">epochs</span>, hi_lo_cut <span class="op">=</span> <span class="va">hi_lo_cut</span>, reference <span class="op">=</span> <span class="va">reference</span>, comparison <span class="op">=</span> <span class="va">comparison</span>, <span class="co">#optional</span></span>
<span>                               mc_comp_method <span class="op">=</span> <span class="va">mc_comp_method</span>, dose_level <span class="op">=</span> <span class="va">dose_level</span>, exp_lab <span class="op">=</span> <span class="va">exp_lab</span>, out_lab <span class="op">=</span> <span class="va">out_lab</span>, colors <span class="op">=</span> <span class="va">colors</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Summary of Exposure Main Effects: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: Out of the total of 50 individuals in the sample, below is the distribution of the 7 (14%) individuals that fall into 3 out of the 3 the total user-defined exposure histories created from 30th and 60th percentile values for low and high levels of exposure ESETA1, respectively, across Infancy, Toddlerhood, Childhood. </span></span>
<span><span class="co">#&gt; USER ALERT: Please inspect the distribution of the sample across the following exposure histories and ensure there is sufficient spread to avoid extrapolation and low precision: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Summary of user-specified exposure ESETA1 histories based on exposure main effects Infancy, Toddlerhood, Childhood containing time points 6, 15, 24:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |history |  n|</span></span>
<span><span class="co">#&gt; |:-------|--:|</span></span>
<span><span class="co">#&gt; |h-h-h   |  3|</span></span>
<span><span class="co">#&gt; |h-h-l   |  2|</span></span>
<span><span class="co">#&gt; |l-l-l   |  2|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Below are the average predictions by user-specified history: </span></span>
<span><span class="co">#&gt; |   | ESETA1.Infancy| ESETA1.Toddlerhood| ESETA1.Childhood| estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history | dose_count|</span></span>
<span><span class="co">#&gt; |:--|--------------:|------------------:|----------------:|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:-------|----------:|</span></span>
<span><span class="co">#&gt; |1  |        -0.5642|            -0.5331|          -0.4885|  -0.0137|    0.1695|   -0.0808|  0.9356|  0.0960|  -0.3460|    0.3186|l-l-l   |          0|</span></span>
<span><span class="co">#&gt; |4  |         0.4722|             0.0684|          -0.4885|   0.1281|    0.1568|    0.8169|  0.4140|  1.2724|  -0.1792|    0.4354|h-h-l   |          2|</span></span>
<span><span class="co">#&gt; |8  |         0.4722|             0.0684|           0.2449|  -0.0185|    0.1584|   -0.1166|  0.9072|  0.1405|  -0.3289|    0.2920|h-h-h   |          3|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Conducting multiple comparison correction for all pairings between comparison histories and each refernece history using the BH method. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: please inspect the following comparisons: </span></span>
<span><span class="co">#&gt; |term                                                    | estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history        |dose   | p.value_corr|</span></span>
<span><span class="co">#&gt; |:-------------------------------------------------------|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:--------------|:------|------------:|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, 0.2449)  |     0.00|      0.21|     -0.02|    0.98|    0.03|    -0.41|      0.40|l-l-l vs h-h-h |0 vs 3 |         0.98|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, -0.4885) |     0.14|      0.17|      0.83|    0.41|    1.29|    -0.20|      0.48|l-l-l vs h-h-l |0 vs 2 |         0.82|</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-49-1.png" width="700"></p>
<p>We find, …</p>
<p>We then compare the same histories usign the model fit with weights
trimmed at the 98th quantile value.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">models.s2</span> </span>
<span></span>
<span><span class="va">results.s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareHistories.html">compareHistories</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="va">exposure</span>, exposure_time_pts <span class="op">=</span> <span class="va">exposure_time_pts</span>, outcome <span class="op">=</span> <span class="va">outcome</span>, model <span class="op">=</span> <span class="va">model</span>, <span class="co">#required</span></span>
<span>                               epochs <span class="op">=</span> <span class="va">epochs</span>, hi_lo_cut <span class="op">=</span> <span class="va">hi_lo_cut</span>, reference <span class="op">=</span> <span class="va">reference</span>, comparison <span class="op">=</span> <span class="va">comparison</span>, <span class="co">#optional</span></span>
<span>                               mc_comp_method <span class="op">=</span> <span class="va">mc_comp_method</span>, dose_level <span class="op">=</span> <span class="va">dose_level</span>, exp_lab <span class="op">=</span> <span class="va">exp_lab</span>, out_lab <span class="op">=</span> <span class="va">out_lab</span>, colors <span class="op">=</span> <span class="va">colors</span>, <span class="co">#optional</span></span>
<span>                               home_dir <span class="op">=</span> <span class="va">home_dir</span>, verbose <span class="op">=</span> <span class="va">verbose</span>, save.out <span class="op">=</span> <span class="va">save.out</span><span class="op">)</span> <span class="co">#optional</span></span>
<span><span class="co">#&gt; Summary of Exposure Main Effects: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: Out of the total of 50 individuals in the sample, below is the distribution of the 7 (14%) individuals that fall into 3 out of the 3 the total user-defined exposure histories created from 30th and 60th percentile values for low and high levels of exposure ESETA1, respectively, across Infancy, Toddlerhood, Childhood. </span></span>
<span><span class="co">#&gt; USER ALERT: Please inspect the distribution of the sample across the following exposure histories and ensure there is sufficient spread to avoid extrapolation and low precision: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Table: Summary of user-specified exposure ESETA1 histories based on exposure main effects Infancy, Toddlerhood, Childhood containing time points 6, 15, 24:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; |history |  n|</span></span>
<span><span class="co">#&gt; |:-------|--:|</span></span>
<span><span class="co">#&gt; |h-h-h   |  3|</span></span>
<span><span class="co">#&gt; |h-h-l   |  2|</span></span>
<span><span class="co">#&gt; |l-l-l   |  2|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Below are the average predictions by user-specified history: </span></span>
<span><span class="co">#&gt; |   | ESETA1.Infancy| ESETA1.Toddlerhood| ESETA1.Childhood| estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history | dose_count|</span></span>
<span><span class="co">#&gt; |:--|--------------:|------------------:|----------------:|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:-------|----------:|</span></span>
<span><span class="co">#&gt; |1  |        -0.5642|            -0.5331|          -0.4885|   0.0017|    0.1659|    0.0103|  0.9918|  0.0119|  -0.3234|    0.3269|l-l-l   |          0|</span></span>
<span><span class="co">#&gt; |4  |         0.4722|             0.0684|          -0.4885|   0.2152|    0.1644|    1.3086|  0.1907|  2.3909|  -0.1071|    0.5374|h-h-l   |          2|</span></span>
<span><span class="co">#&gt; |8  |         0.4722|             0.0684|           0.2449|   0.0392|    0.1656|    0.2367|  0.8129|  0.2989|  -0.2853|    0.3637|h-h-h   |          3|</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Conducting multiple comparison correction for all pairings between comparison histories and each refernece history using the BH method. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; USER ALERT: please inspect the following comparisons: </span></span>
<span><span class="co">#&gt; |term                                                    | estimate| std.error| statistic| p.value| s.value| conf.low| conf.high|history        |dose   | p.value_corr|</span></span>
<span><span class="co">#&gt; |:-------------------------------------------------------|--------:|---------:|---------:|-------:|-------:|--------:|---------:|:--------------|:------|------------:|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, 0.2449)  |     0.04|      0.21|      0.18|    0.86|    0.22|    -0.38|      0.46|l-l-l vs h-h-h |0 vs 3 |         0.86|</span></span>
<span><span class="co">#&gt; |(-0.5642, -0.5331, -0.4885) - (0.4722, 0.0684, -0.4885) |     0.21|      0.18|      1.16|    0.25|    2.02|    -0.15|      0.57|l-l-l vs h-h-l |0 vs 2 |         0.49|</span></span></code></pre></div>
<p><img src="Workflow_Continuous_Exposure_files/figure-html/unnamed-chunk-50-1.png" width="700"></p>
<p>We find, …</p>
<p>In general, from the sensitivity analyses, we find…</p>
<p><br><br></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Arel-Bundock, V. 2023. marginaleffects: Predictions, Comparisons,
Slopes, Marginal Means,and Hypothesis Tests. <a href="https://CRAN.R-project.org/package=marginaleffects" class="external-link uri">https://CRAN.R-project.org/package=marginaleffects</a>.</p>
<p>Cole, S. R., &amp; Hernán, M. A. (2008). Constructing Inverse
Probability Weights for Marginal Structural Models. American Journal of
Epidemiology, 168(6), 656–664. <a href="https://doi.org/10.1093/aje/kwn164" class="external-link uri">https://doi.org/10.1093/aje/kwn164</a>.</p>
<p>Greifer, Noah. 2023.WeightIt: Weighting for Covariate Balance in
Observational Studies. <a href="https://CRAN.R-project.org/package=WeightIt" class="external-link uri">https://CRAN.R-project.org/package=WeightIt</a>.</p>
<p>Lumley, Thomas. 2023. “survey: Analysis of Complex Survey
Samples.”</p>
<p>Polley, Eric, Erin LeDell, Chris Kennedy, and Mark van der Laan.
2023. SuperLearner: SuperLearner Prediction. <a href="https://CRAN.R-project.org/package=SuperLearner" class="external-link uri">https://CRAN.R-project.org/package=SuperLearner</a>.</p>
<p>R Core Team (2013). R: A language and environment for statistical
computing. R Foundation for Statistical Computing, Vienna, Austria. ISBN
3-900051-07-0, URLhttp://www.R-project.org/.</p>
<p>Stuart, E. A. (2010). Matching methods for causal inference: A review
and a look forward. Statistical Science: A Review Journal of the
Institute of Mathematical Statistics, 25(1), 1–21. <a href="https://doi.org/10.1214/09-STS313" class="external-link uri">https://doi.org/10.1214/09-STS313</a>.</p>
<p>Thoemmes, F., &amp; Ong, A. D. (2016). A Primer on Inverse
Probability of Treatment Weighting and Marginal Structural Models. <a href="https://doi.org/10.1177/2167696815621645" class="external-link uri">https://doi.org/10.1177/2167696815621645</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Isabella Stallworthy, Noah Greifer, Meriah DeJoseph, Emily Padrutt, Daniel Berry.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
